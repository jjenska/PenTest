# h2

Tarkemmat tehtävänannot löytyvät osoitteesta: [terokarvinen.com](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h2-sniff-n-scan).

## x) Lue/katso ja tiivistä.

Hoikkala "joohoi" 2020: Still Fuzzing Faster (U fool). In HelSec Virtual meetup #1.

Lyon 2009: Nmap Network Scanning: Chapter 15. Nmap Reference Guide: Port Scanning Basics (termit: open, closed, filtered), Port Scanning Techniques (komennot: -sS -sT -sU)

| Portin tila | Kuvaus |
| --- | ----------- |
| open | Palvelu hyväksyy TCP-yhteyksiä, UDP-datagrams tai SCTP-yhteyksiä aktiivisesti. Näiden löytäminen on usein porttiskannauksen päätarkoitus. |
| closed | Suljettu portti on tavoitettavissa, mutta mikään palvelu ei kuuntele sitä. Voi olla hyödyllistä skannata myöhemmin uudelleen. |
| filtered | Nmap ei pysty selvittämään, mikäli portti on auki, koska pakettien filtteröinti estää sen. Filtteröinti voi johtua laitteesta, joka sisältää palomuurin, reitittimen säännöistä tai host-based palomuurisovelluksesta. Usein tiedusteluyritykset lopetetaan ilman vastausta, mikä kuormittaa skannausta filtteröityyn porttiin, sillä Nmap yrittää sknnausta useamman kerran uudelleen. |

*Lähde: [Nmap - Port Scanning Basics](https://nmap.org/book/man-port-scanning-basics.html)*
### Nmap komennot 

```-sS``` (=TCP SYN scan)
Nmap:n suosituin vaihtoehto. Toimii nopeasti, on lisäksi huomaamaton ja vaivihkainen, sillä se ei
ikinä muodosta täyttä TCP-yhteyttä. Nmap tiedustelee ensin onko portti auki (SYN), jonka jälkeen palvelu vastaa (SYN/ACK), tämän
jälkeen Nmap katkaisee yhteyden (RST).

```-sT``` (= TCP connect scan)
Oletus, mikäli SYN-skannaus ei ole vaihtoehto. Skannaus joka noudattaa normaalin verkkoliikenteen sääntöjä, eli muodostaa täyden TCP-yhteyden. Vie kaueman aikaa ja vaatii enemmän paketteja keräämään samaa tietoa, lisäksi kohdekoneet todennäköisemmin logittavat yhteyden.

```-sU``` (UDP scans)
UDP-skannaus on yleisesti hitaampaa ja vaikeampaa kuin TCP, joten joskus tietoturvassa nämä portit jäävät huomioimatta. UDP- ja TCP-skannaus 
voidaan ajaa myös yhdessä. Lähettää UDP-paketin jokaiseen kohdeporttiin. 

*Lähde: [Nmap - Port Scanning Techniques](https://nmap.org/book/man-port-scanning-techniques.html)*

## a) Ratkaise Teron ffuf-haastebinääri.

Seurasin asentamisessa Teron [ohjeita](https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/), harjoitellakseni ensin ffuf:n käyttöä. Koneellani ei ollut wget:ä, joten asensin sen ensin. Tämän jälkeen latasin esimerkkidatan, annoin oikeudet tiedoston suorittamiselle, ja ajoin sen:

```
$ sudo apt-get -y install wget 
$ wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0
$ chmod u+x dirfuzt-0
$ ./dirfuzt-0
```
Testasin selaimessa IP:llä, että kaikki toimii:

kuva

Käytössäni on Debian, joten avasin uuden terminaalin ja asensin ffuf:n. Tämän jälkeen purin tiedoston kotihakemistoon.

```
$ wget https://github.com/ffuf/ffuf/releases/download/v2.0.0/ffuf_2.0.0_linux_amd64.tar.gz
$ tar -xf ffuf_2.0.0_linux_amd64.tar.gz
```
Komennolla ```./ffuf``` sain näkyviiin kaikki flagit ohjeineen. Sitten asensin valmiin sanakirjan:

```
$ wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt
```
Tarkistin vielä tiedoston rivien lukumäärän ```wc -l common.txt```. Yhteensä se sisälsi 4723. Tämän jälkeen suljin virtuaalikoneen, ja
kytkin asetuksista internet-yhteyden poikki. "Settings" -> "Network" -> "Adapter 1" -> "Enable Network Adapter" täppä pois -> "OK". Sitten
koneen käynnistys. Työpöydän alapalkin kuvake näytti, että yhteyttä ei ole. Testauksena pingasin vielä 8.8.8.8, josta sain
vastauksen "Network is unreachable". Sitten ajoin uudelleen tiedoston ./dirfuzt, jotta sain yhteyden päälle taustalle. 
Tämän jälkeen ajoin rivit tiedostosta common.txt

```
 $ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
```
Ohjelma lähti tehokkaasti 3703 pyyntöä/s vauhdilla. Vastauksia tuli valtava lista. Ohjeiden mukaan hyvä tapa
käydä läpi vastauksia olisi esimerkiksi niiden koon kautta. Useimmissa pyynnöissä vastaus oli status 200 (OK) ja tavukooltaan 132, eli lyhyitä. Näin ollen filtteröin vastauksia ```-fs tavukoko```:

```
$ ./fuff -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132
```
Tämä tuotti halutun tuloksen, sillä vastauksia filtteröityi enää 2 kappaletta:

kuva

Tämän jälkeen lähdin tekemään virallista harjoitusta dirfutz-1. Yhdistin koneen takaisin internettiin, jotta sain ladattua tarvittavan sisällön. Annoin oikeudet tiedoston ajamiseen ja testasin selaimella toiminnan. 

```
$ wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-1
$ chmod u+x dirfuzt-1
$ ./dirfuzt-1
```
Sen jälkeen katkaisin yhteyden internettiin ja tein pingauksen testiksi. Testasin samalla aikaisemmalla tekniikalla, käyden läpi tiedoston kaikki rivit:

```
$ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
```
Haku tuotti tulokseksi tuhansia vastauksia. Yhteistä niille näytti olevan tavukoko 154. Näin ollen lisäsin saman filtterin kuin harjoituksessa:
```
$ ./fuff -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 154
```
Tällä sain vastaukset suodatettua 7 kappaleeseen, joista löytyi esim. "wp-admin", sekä versionhallintaan liittyvät git-päätteet.

kuva

## b) Asenna Ffufme harjoitusmaali paikallisesti omalle koneellesi. Ratkaise tehtävät (paitsi "Content Discovery - Pipes").

## Porttiskannaa paikallinen kone (127.0.0.2 tms), sieppaa liikenne snifferillä, analysoi:

Käytin snifferinä Wiresharkia Debian 12 virtuaalikoneella. Kohteenani oli Metasploitable virtuaaliverkossa.

## c) nmap TCP connect scan -sT

-sT komento noudattaa tavallista TCP-liikennettä, joka perustuu kolmivaiheeseen kädenpuristukseen *(man nmap*, *[baeldung](https://www.baeldung.com/cs/handshakes)*). Kohdistin skannaukseni metasploitable:n porttiin 80, sillä tiesin sen olevan auki.

```console
jenni@hhpt:~$ sudo nmap -sT -p 80 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 12:48 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00022s latency).

PORT   STATE SERVICE
80/tcp open  http
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
```
wire kuva

Wiresharkilla näkyi TCP liikenne, jossa nmap lähettää SYN-yhteyspyynnön portille 80. Portin 80 palvelu lähettää tämän jälkeen SYN-ACK paketin, jolla se kuittaa, että pavelu on ylhäällä ja kuuntelee. Tämän jälkeen alkuperäinen yhteyspyynnön lähettäjä hyväksyy lähettämällä ACK-paketin (*[baeldung](https://www.baeldung.com/cs/handshakes)*). Tämän jälkeen TCP-yhteys katkaistaan (RST, ACK).

## d) nmap TCP SYN "used to be stealth" scan, -sS (tätä käytetään skannatessa useimmin)

Määrittelemällä ```-sS```, TCP-yhteyttä ei muodosteta kokonaan. Testasin skannauksen samaiseen porttiin 80.

```console
jenni@hhpt:~$ sudo nmap -sS -p 80 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 12:55 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00018s latency).

PORT   STATE SERVICE
80/tcp open  http
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
```

wire kuva

Wiresharkilla tarkasteltaessa rivillä 1 näkyy SYN-yhteyspyyntö porttiin 80, jonka kohde vahvistaa SYN-ACK paketilla. Tämän jälkeen Nmap katkaisee TCP-yhteyden (RST), kuin yhteyden avaamisesta ei olisi keskusteltukaan.

## e) nmap ping sweep -sn

```-sN``` ei hyödynnä laisinkaan porttiskannausta, vaan suorittaa ping kyselyn määritetyille IP-osoitteille. Tämä tulostaa kaikki tiedusteluun vastaavat kohdekoneet *(man nmap)*.

```console
jenni@hhpt:~$ sudo nmap -sn 192.168.60.0/24
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 14:00 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.1
Host is up (0.00015s latency).
MAC Address: 0A:00:27:00:00:39 (Unknown)
Nmap scan report for 192.168.60.2
Host is up (0.00025s latency).
MAC Address: 08:00:27:86:F6:25 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.60.6
Host is up (0.00023s latency).
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.60.4
Host is up.
Nmap done: 11 IP addresses (4 hosts up) scanned in 1.24 seconds
```

Kokeilin ensin laajemman IP-haun, jonka jälkeen kokeilin myös rajata osoitteet 1-10. Tuloksena sain 4kpl vastauksia, joista 192.168.60.4 oli kone, jolla skannasin. Wiresharkilla näkyi, miten nmap lähetti ARP-kyselyn määriteltyyn IP-avaruuteen. Riveillä 10,12 ja 13 näkyvät MAC-vastaukset ARP-kyselyyn.

## f) nmap don't ping -Pn

...

## g) nmap version detection -sV (esimerkki yhdestä palvelusta yhdessä portissa riittää)

```-sV``` (service & version detection) hyödyntää Nmapin tietokantaa, josta löytyy yli 2200 palvelua. Näin ollen Nmap ilmoittaa, että kyseiset portit kuten vaikka 80 vastaavat tiettyyn palveluun, esim. web-palvelimeen (HTTP). Tähän ei voi kuitenkaan tietoturvan näkökulmasta aina täysin luottaa, sillä palveluita voidaan ylläpitää myös erikoisissa porteissa. Version tunnistus auttaa palveluiden havoittuvuuksien tunnistamisessa, koska se näyttää versionumerot. *(man nmap)*

```console
jenni@hhpt:~$ sudo nmap -sV -p 80 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 15:25 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00020s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) DAV/2)
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.40 seconds
```

Service-sarakkeessa näkyi palveluna http ja version-sarakkeessa Apache httpd 2.2.8 (Ubuntu), joka piti paikkansa. Tällä versiolla voisi kenties hakea, esim. millaisia haavoittuvuuksia siitä löytyy. Wiresharkin liikenteessä näkyi ensin ARP-tiedustelu, jonka jälkeen TCP-yhteyden avaus ja muodostaminen. Wireshark tallensi myös HTTP-liikenettä kuten GET ja POST-pyyntöjä. 

## h) nmap output files -oA foo. Miltä tiedostot näyttävät? Mihin kukin tiedostotyyppi sopii?

Voidaan määrittää tiedostonimi, esim. itselläni ```-oA scanData```, jolloin Nmap tallentaa tulokset scanData.nmap, scanData.gnmap ja scanData.xml tiedostomuodoissa *(man nmap)*. Alla oleva .nmap-tiedostotyyppi tulostaa jokaisen skannauksen tiedon omalle rivilleen. Tämä tekee siitä helppolukuisen, ja voisi hyödyntää esim. raportoinnissa. Skannaukseen käytin kommentissa näkyvää komentoa ```$ sudo nmap -oA scanData 192.168.60.60```.

```console
jenni@hhpt:~$ cat scanData.nmap
# Nmap 7.93 scan initiated Fri Nov  3 16:15:50 2023 as: nmap -oA scanData 192.168.60.6
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.000094s latency).
Not shown: 977 closed tcp ports (reset)
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
23/tcp   open  telnet
# ...
# jatkuu useampi rivi
```

...

## i) nmap ajonaikaiset toiminnot (man nmap: runtime interaction): verbosity v/V, help ?, packet tracing p/P, status s (ja moni muu nappi)

Nmapin ajon aikana, kaikki näppäimien painallukset otetaan huomioon. Tämä mahdollistaa vuorovaikutuksen ohjelman kanssa, ilman, että sitä täytyy pysäyttää ja käynnistää uudelleen. Pienellä kirjoitetut kirjaimet nostavat tulostuksen määrää, isolla taas pienentävät. Apunappina toimii "?", joka ajon aikana antaa lisätietoikkunan. (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

```v / V``` = lisää / laske verbositeettiä (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

```d / D``` = lisää / laske debuggausen tasoa (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

```p / P``` = aseta päälle / pois pakettien jäljitys (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)


## j) Ninjojen tapaan. Piiloutuuko nmap-skannaus hyvin palvelimelta? Vinkkejä: Asenna Apache. Aja nmap-versioskannaus -sV tai -A omaan paikalliseen weppipalvelimeen. Etsi Apachen lokista tätä koskevat rivit. Wiresharkissa "http" on kätevä filtteri, se tulee siihen yläreunan "Apply a display filter..." -kenttään. Nmap-ajon aikana p laittaa packet tracing päälle. Vapaaehtoinen lisäkohta: jääkö Apachen lokiin jokin todiste nmap-versioskannauksesta?

...

## k) UDP-skannaus. UDP-skannaa paikkalinen kone (-sU). "Mulla olis vitsi UDP:sta, mutta en tiedä menisikö se perille":

...

## l) Miksi UDP-skannaus on hankalaa ja epäluotettavaa? Miksi UDP-skannauksen kanssa kannattaa käyttää --reason flagia ja snifferiä?

Avoimet tai filtteröidyt portit harvoin lähettävät vastausta, jolloin Nmap aikakatkaisee yhteyden ja yrittää ohjata liikennettää uudelleen varmuudeksi, mikäli tiedustelu tai vastaus mahdollisesti hukattiin. Tämä myös tekee skannauksesta hidasta. *(man nmap)*

Suljetut portit saattavat olla vielä suurempi ongelma. Ne usein lähettävät "ICMP port unreachable" -virheen. Syn-skannauksessa RST-paketit lähetetään vastauksena suljetuista TCP porteista, mutta monet hostit rajoittavat ICMP porttien viestejä oletusarvoisesti. Nmap tunnistaa rajoituksen ja hidastaa skannausta välttääkseen verkon ruuhkauttamisen turhilla paketeilla, jotka kohdekone pudottaa. *(man nmap)*

--reason flag voi helpottaa porttien tilojen syiden määritystä. *[port scanning options](https://nmap.org/book/port-scanning-options.html)*

