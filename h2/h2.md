# h2

Tehtävien tekemiseen käytettiin pöytäkonetta:

- Prosessori: AMD Ryzen 5 3600 6-Core Processor 3.59 GHz
- Kovalevy: 256 GB M.2 SSD, 512 GB SSD
- Muisti: 32GB RAM
- Käyttöjärjestelmä: Windows 10 Pro
- VirtualBox

ja virtuaalikoneita:

- Debian 12 (2 eri), Metasploitable2

Tarkemmat tehtävänannot löytyvät osoitteesta: [terokarvinen.com](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h2-sniff-n-scan).

## x) Lue/katso ja tiivistä.

Hoikkala "joohoi" 2020: Still Fuzzing Faster (U fool). In HelSec Virtual meetup #1.

- web fuzzer lähettää useita melkein samankaltaisia pyyntöjä, ja yrittää tunnistaa niistä poikkeamia
- ffuf:ssa arvona käytetään "/FUZZ", joka toimii annetun tietosisällön tilalla
- mahdollisia input arvoja fuzzerille: salasanalistat, käyttäjälistat, API väylät(path), parametrien nimet ja arvot
- tyypillisiä kohteita: GET parametrit (nimet, arvot, molemmat), Headers (host, auth, cookies, proxy), POST data (lomakkeet, JSON, tiedostot)
- tarjolla paljon eri palveluita: ffuf, burb suite, dirb, dirbuster...

Lyon 2009: Nmap Network Scanning: Chapter 15. Nmap Reference Guide: Port Scanning Basics (termit: open, closed, filtered), Port Scanning Techniques (mitä ovat: -sS -sT -sU)

| Portin tila | Kuvaus |
| --- | ----------- |
| open | Palvelu hyväksyy TCP-yhteyksiä, UDP-datagrams tai SCTP-yhteyksiä aktiivisesti. Näiden löytäminen on usein porttiskannauksen päätarkoitus. |
| closed | Suljettu portti on tavoitettavissa, mutta mikään palvelu ei kuuntele sitä. Voi olla hyödyllistä skannata myöhemmin uudelleen. |
| filtered | Nmap ei pysty selvittämään, mikäli portti on auki, koska pakettien filtteröinti estää sen. Filtteröinti voi johtua laitteesta, joka sisältää palomuurin, reitittimen säännöistä tai host-based palomuurisovelluksesta. Usein tiedusteluyritykset lopetetaan ilman vastausta, mikä kuormittaa skannausta filtteröityyn porttiin, sillä Nmap yrittää sknnausta useamman kerran uudelleen. |

*Lähde: [Nmap - Port Scanning Basics](https://nmap.org/book/man-port-scanning-basics.html)*
### Nmap porttiskannauksen perusteet 

- suurin osa skannauksista saatavilla vain pääkäyttäjän oikeuksilla Unix järjestelmissä
- vain yhtä tapaa voidaan käyttää kerrallaan, poikkeuksena UDP-skannaus (-sU), voidaan yhdistää esim. TCP-skannaukseen

- ```-sS``` (=TCP SYN scan)
Nmap:n suosituin vaihtoehto. Toimii nopeasti, on lisäksi huomaamaton ja vaivihkainen, sillä se ei
ikinä muodosta täyttä TCP-yhteyttä. Nmap tiedustelee ensin onko portti auki (SYN), jonka jälkeen palvelu vastaa (SYN/ACK), tämän
jälkeen Nmap katkaisee yhteyden (RST).

- ```-sT``` (= TCP connect scan)
Oletus, mikäli SYN-skannaus ei ole vaihtoehto. Skannaus joka noudattaa normaalin verkkoliikenteen sääntöjä, eli muodostaa täyden TCP-yhteyden. Vie kaueman aikaa ja vaatii enemmän paketteja keräämään samaa tietoa, lisäksi kohdekoneet todennäköisemmin logittavat yhteyden.

- ```-sU``` (UDP scans)
UDP-skannaus on yleisesti hitaampaa ja vaikeampaa kuin TCP, joten joskus tietoturvassa nämä portit jäävät huomioimatta. UDP- ja TCP-skannaus 
voidaan ajaa myös yhdessä. Lähettää UDP-paketin jokaiseen kohdeporttiin. 

*Lähde: [Nmap - Port Scanning Techniques](https://nmap.org/book/man-port-scanning-techniques.html)*

## a) Ratkaise Teron ffuf-haastebinääri.

Seurasin asentamisessa Teron *[ohjeita](https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/)*, harjoitellakseni ensin ffuf:n käyttöä. Koneellani ei ollut wget:ä, joten asensin sen ensin. Tämän jälkeen latasin esimerkkidatan, annoin oikeudet tiedoston suorittamiselle, ja ajoin sen:

```
$ sudo apt-get -y install wget 
$ wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0
$ chmod u+x dirfuzt-0
$ ./dirfuzt-0
```
Testasin selaimessa IP:llä, että kaikki toimii:

![127-8000](https://github.com/jjenska/PenTest/assets/105623785/df7b56b9-98c8-4c5e-8cf0-a3f06b06bb15)

Käytössäni on Debian, joten avasin uuden terminaalin ja asensin ffuf:n. Tämän jälkeen purin tiedoston kotihakemistoon.

```
$ wget https://github.com/ffuf/ffuf/releases/download/v2.0.0/ffuf_2.0.0_linux_amd64.tar.gz
$ tar -xf ffuf_2.0.0_linux_amd64.tar.gz
```
Komennolla ```./ffuf``` sain näkyviiin kaikki ominaisuudet ohjeineen. Sitten asensin valmiin sanakirjan:

```
$ wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt
```
Tarkistin vielä tiedoston rivien lukumäärän ```wc -l common.txt```. Yhteensä se sisälsi 4723. Tämän jälkeen suljin virtuaalikoneen, ja
kytkin asetuksista internet-yhteyden poikki. "Settings" -> "Network" -> "Adapter 1" -> "Enable Network Adapter" täppä pois -> "OK". Sitten
koneen käynnistys. Työpöydän alapalkin kuvake näytti, että yhteyttä ei ole. Testauksena pingasin vielä 8.8.8.8, josta sain
vastauksen "Network is unreachable". Sitten ajoin uudelleen tiedoston ./dirfuzt, jotta sain yhteyden päälle taustalle. 
Tämän jälkeen ajoin rivit tiedostosta common.txt

```
 $ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
```
Ohjelma rullasi tehokkaasti 3703 pyyntöä/s vauhdilla. Vastauksia tuli valtava lista. Ohjeiden mukaan hyvä tapa käydä niitä läpi olisi esimerkiksi niiden koon perusteella. Useimmissa pyynnöissä vastaus oli status 200 (OK) ja tavukooltaan 132, eli lyhyitä. Näin ollen filtteröin vastauksia ```-fs tavukoko```:

```
$ ./fuff -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132
```
Tämä tuotti halutun tuloksen, sillä vastauksia filtteröityi enää 2 kappaletta:

![result-admin](https://github.com/jjenska/PenTest/assets/105623785/44960523-5147-48d4-80f4-6dadd7792f44)


Tämän jälkeen lähdin tekemään virallista harjoitusta dirfutz-1. Yhdistin koneen takaisin internettiin, jotta sain ladattua tarvittavan sisällön. Annoin oikeudet tiedoston ajamiseen ja testasin selaimella toiminnan. 

```
$ wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-1
$ chmod u+x dirfuzt-1
$ ./dirfuzt-1
```
Sen jälkeen katkaisin yhteyden internettiin ja tein pingauksen testiksi. Testasin samalla aikaisemmalla tekniikalla, käyden läpi tiedoston kaikki rivit:

```
$ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ
```
Haku tuotti tulokseksi tuhansia vastauksia. Yhteistä niille näytti olevan tavukoko 154. Näin ollen lisäsin saman filtterin kuin harjoituksessa:
```
$ ./fuff -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 154
```
Tällä sain vastaukset suodatettua 7 kappaleeseen, joista löytyi esim. "wp-admin", sekä versionhallintaan liittyvät git-päätteet.

![harkka2fs](https://github.com/jjenska/PenTest/assets/105623785/f4aca3b0-6f22-455c-a10a-c11cd301f4d6)
![admin2](https://github.com/jjenska/PenTest/assets/105623785/195c81af-a57a-4513-915f-c65db3a88ddd)


## b) Asenna Ffufme harjoitusmaali paikallisesti omalle koneellesi. Ratkaise tehtävät (paitsi "Content Discovery - Pipes").

Tein tämän harjoituksen eri virtuaalikoneella (tämäkin Debian 12), kuin kohdan (a. Asensin ensin tarvittavat työkalut koneelleni.

```console
$ sudo apt-get install docker.io git golang-go
```
Tämän jälkeen kloonasin ffuf git-tiedoston ja asensin sen:
```console
$ git clone https://github.com/ffuf/ffuf.git
$ cd ffufme/
$ go build
```
Ja jotta voisin ajaa ffuf-komentoa mistä tahansa hakemistosta:
```console
$ sudo cp ffuf /usr/local/bin/
```
Tämän jälkeen loin words-kansion kotihakemistoon ja latasin sinne Teron *[ohjeiden](https://terokarvinen.com/2023/fuffme-web-fuzzing-target-debian/)* mukaan sanalistat:

```console
$ wget http://ffuf.me/wordlist/common.txt
$ wget http://ffuf.me/wordlist/parameters.txt 
$ wget http://ffuf.me/wordlist/subdomains.txt
```
Sitten kloonasin kotihakemistoon ffufme harjoitusmateriaalit, rakensin kontin ja ajoin sen:

```console
$ git clone https://github.com/adamtlangley/ffufme
$ cd ffufme/
$ sudo docker build -t ffufme .
$ sudo docker run -d -p 80:80 ffufme
```
![ffufme](https://github.com/jjenska/PenTest/assets/105623785/4f186707-da6a-4127-aba7-97ad3a1715ae)

#### HARJOITUKSET:
#### Content Discovery - Basic Content Discovery:

Tämän avulla tulisi löytää tiedostot "class" ja "development.log", ja löytyihän ne:

```console
$ ffuf -w ~/words/common.txt -u http://localhost/cd/basic/FUZZ
```
![foundbasic](https://github.com/jjenska/PenTest/assets/105623785/7b8fb76f-700d-4307-9836-3cde835958b5)

#### Content Discovery - Recursion

Tässä hyödynnettiin ```-recursion``` "kytkintä". Se kertoo ffuf:lle, että mikäli se löytää hakemiston, ffuf:n tulisi aloittaa skannaamaan sen sisällä, kunnes hakutuloksia ei enää synny. Tuloksena täytyi saada hakemisto "/admin", jonka jälkeen "/admin/users", ja lopuksi "/admin/users/96". Tämä toimi kuten kuuluikin.

```console
$ ffuf -w ~/words/common.txt -recursion -u http://localhost/cd/recursion/FUZZ
```
![foundRecursion](https://github.com/jjenska/PenTest/assets/105623785/04eb7578-864a-4dae-8e96-1ed10a311fce)

#### Content Discovery - File Extensions

Tässä vaiheessa ollaan löydetty hakemisto nimeltä "/logs", mutta sisältöä ei pysty näyttämään. Voidaan olettaa, että tiedostot sisällä käyttävät .log päätettä. ```-e``` määrittelee tiedostonimen päätteen, jonka jälkeen lisätään ".log". Näin pitäisi löytää "/logs/users.log". Ja se löytyikin:

```console
$ ffuf -w ~/words/common.txt -e .log -u http://localhost/cd/ext/logs/FUZZ
```
![foundusrslog](https://github.com/jjenska/PenTest/assets/105623785/590945cc-2d58-445f-8081-c5367a0704c9)

#### Content Discovery - No 404 Status

Ensin ajettiin esimerkkikomento:

```console
$ ffuf -w ~/words/common.txt -u http://localhost/cd/no404/FUZZ
```
Tämä antoi pitkän listan HTTP vastauksella Status 200 (OK), tavukooltaan 669. Eli "Page Cannot Be Found" viesti ei palauta 404 headeriä. Filtteröidään siis kaikki tavukoon 669 mukaan, jolloin tulokseksi tulisi saada "secret". Tämä onnistui:

```console
$ ffuf -w ~/words/common.txt -u http://localhost/cd/no404/FUZZ -fs 669
```
![foundsecret](https://github.com/jjenska/PenTest/assets/105623785/5cef14f8-57db-40fb-9b9b-6d530209a1dc)

#### Content Discovery - Param Mining

Vierailemalla sivulla "/cd/param/data" saadaan viestiksi "Required Parameter Missing" ja HTTP statuksena 400, eli Bad Request. Pyynnöllä voidaan etsiä kadoksissa oleva parametri "debug":

```console
$ ffuf -w ~/words/parameters.txt -u http://localhost/cd/param/data?FUZZ=1
```
![founddebug](https://github.com/jjenska/PenTest/assets/105623785/a077bf08-d385-4fb8-9e4a-f2d7286cd6d7)

#### Content Discovery - Rate Limited

Joskus palveluissa on rajoituksia, kuinka monta pyyntöä voidaan tehdä per sekunti. Tässä harjoituksessa ajettiin hakemistoa, jonka rajoitus oli 50 pyyntöä/s. Ajon aikana tulee paljon 429 HTTP statuksia, joka tarkoittaa, että pyyntöjen tekeminen estetään muutamaksi sekunniksi.

```-mc``` määrittelee statuksiksi ainoastaan 200 ja 429:
```console
$ ffuf -w ~/words/common.txt -u http://ffuf.test/cd/rate/FUZZ -mc 200,429
```

En saanut kyseisellä komennolla lainkaan listattuja virheitä. Kokeilin vielä lisätä ```-p```, joka määrittelee ohjelman pysähtymään 0,1 sekuntia per pyyntö ja ```-t```, joka luo 5 versiota ffuf:sta (= max 50 pyyntöä/s). Olisi pitänyt löytää "oracle"-tiedosto, mutta ei toiminut.

#### Subdomains - Virtual Host Enumeration

Ffuf:a voidaan käyttää myös subdomainien löytämiseen käyttäen virtuaali hostia ja muuttamalla headeria:
```console
$ ffuf -w ~/words/subdomains.txt -H "Host: FUZZ.ffuf.me" -u http://localhost
```
Tällä saatiin tulokseksi vastauksia, joiden kaikkien koko oli 1495 tavua. Näin ollen lisättiin filtteri ```-fs 1495```. Näin löytyi subdomain "redhat":

```console
$ ffuf -w ~/words/subdomains.txt -H "Host: FUZZ.ffuf.me" -u http://localhost -fs 1495
```
![foundredhat](https://github.com/jjenska/PenTest/assets/105623785/a5fdad4d-36f1-45c4-9d17-bd176b2e1a00)


## Porttiskannaa paikallinen kone (127.0.0.2 tms), sieppaa liikenne snifferillä, analysoi:

Käytin snifferinä Wiresharkia Debian 12 virtuaalikoneella. Kohteenani oli Metasploitable virtuaaliverkossa.

## c) nmap TCP connect scan -sT

-sT komento noudattaa tavallista TCP-liikennettä, joka perustuu kolmivaiheeseen kädenpuristukseen *(man nmap*, *[baeldung](https://www.baeldung.com/cs/handshakes)*). Kohdistin skannaukseni metasploitable:n porttiin 80, sillä tiesin sen olevan auki.

```console
jenni@hhpt:~$ sudo nmap -sT -p 80 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 12:48 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00022s latency).

PORT   STATE SERVICE
80/tcp open  http
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
```
![-sTp80](https://github.com/jjenska/PenTest/assets/105623785/ab8ea709-f5c1-44f2-b1b6-aafabe78db87)

Wiresharkilla näkyi TCP liikenne, jossa nmap lähettää SYN-yhteyspyynnön portille 80. Portin 80 palvelu lähettää tämän jälkeen SYN-ACK paketin, jolla se kuittaa, että pavelu on ylhäällä ja kuuntelee. Tämän jälkeen alkuperäinen yhteyspyynnön lähettäjä hyväksyy lähettämällä ACK-paketin (*[baeldung](https://www.baeldung.com/cs/handshakes)*). Tämän jälkeen TCP-yhteys katkaistaan (RST, ACK).

## d) nmap TCP SYN "used to be stealth" scan, -sS (tätä käytetään skannatessa useimmin)

Määrittelemällä ```-sS```, TCP-yhteyttä ei muodosteta kokonaan. Testasin skannauksen samaiseen porttiin 80.

```console
jenni@hhpt:~$ sudo nmap -sS -p 80 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 12:55 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00018s latency).

PORT   STATE SERVICE
80/tcp open  http
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
```

![-sSp80](https://github.com/jjenska/PenTest/assets/105623785/54da17c7-e751-4da2-be0e-8d8a45bb2969)


Wiresharkilla tarkasteltaessa rivillä 1 näkyy SYN-yhteyspyyntö porttiin 80, jonka kohde vahvistaa SYN-ACK paketilla. Tämän jälkeen Nmap katkaisee TCP-yhteyden (RST), kuin yhteyden avaamisesta ei olisi keskusteltukaan.

## e) nmap ping sweep -sn

```-sN``` ei hyödynnä laisinkaan porttiskannausta, vaan suorittaa ping kyselyn määritetyille IP-osoitteille. Tämä tulostaa kaikki tiedusteluun vastaavat kohdekoneet *(man nmap)*.

```console
jenni@hhpt:~$ sudo nmap -sn 192.168.60.0/24
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 14:00 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.1
Host is up (0.00015s latency).
MAC Address: 0A:00:27:00:00:39 (Unknown)
Nmap scan report for 192.168.60.2
Host is up (0.00025s latency).
MAC Address: 08:00:27:86:F6:25 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.60.6
Host is up (0.00023s latency).
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.60.4
Host is up.
Nmap done: 11 IP addresses (4 hosts up) scanned in 1.24 seconds
```
![pingweep2](https://github.com/jjenska/PenTest/assets/105623785/f2d82b45-6fbd-4d6d-b8e3-60c00608a6e1)

Kokeilin ensin laajemman IP-haun, jonka jälkeen kokeilin myös rajata osoitteet 1-10. Tuloksena sain 4kpl vastauksia, joista 192.168.60.4 oli kone, jolla skannasin. Wiresharkilla näkyi, miten nmap lähetti ARP-kyselyn määriteltyyn IP-avaruuteen. Riveillä 10,12 ja 13 näkyvät MAC-vastaukset ARP-kyselyyn.

## f) nmap don't ping -Pn

```-Pn``` skippaa hostien etsimisen kokonaan, eli Nmap yrittää ehdottaa skannaus toimintoja jokaiseen kohteeksi määriteltyyn IP-osoitteeseen, riippumatta siitä onko se käytössä/ylhäällä. Paikallisessa verkossa ARP-tiedustelu tehdään joka tapauksessa (voidaan sulkea pois esim. ```--disable-arp-ping```). *([Nmap - host discovery](https://nmap.org/book/man-host-discovery.html))*

```console
jenni@hhpt:~$ sudo nmap -Pn 192.168.60.0-10
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-04 17:04 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.1
Host is up (0.00018s latency).
All 1000 scanned ports on 192.168.60.1 are in ignored states.
Not shown: 1000 filtered tcp ports (no-response)
MAC Address: 0A:00:27:00:00:39 (Unknown)

Nmap scan report for 192.168.60.2
Host is up (0.00013s latency).
All 1000 scanned ports on 192.168.60.2 are in ignored states.
Not shown: 1000 filtered tcp ports (proto-unreach)
MAC Address: 08:00:27:B1:E3:2F (Oracle VirtualBox virtual NIC)

Nmap scan report for 192.168.60.6
Host is up (0.00018s latency).
Not shown: 977 closed tcp ports (reset)
PORT     STATE SERVICE
21/tcp   open  ftp
# ... loput avoimet portit

Nmap scan report for 192.168.60.4
Host is up (0.0000050s latency).
Not shown: 999 closed tcp ports (reset)
PORT   STATE SERVICE
80/tcp open  http

Nmap done: 11 IP addresses (4 hosts up) scanned in 5.08 seconds
```
![-Pn](https://github.com/jjenska/PenTest/assets/105623785/682661b0-8289-4104-89b1-1d3c10a6fb23)

Kokeilin vertailuksi hakua ilman ```-Pn``` määritelmää eli:
```$ sudo nmap 192.168.60.0-10```

Tuloksissa ei ollut ajallisesti juurikaan eroa 5.08 sekuntia vs. 5.07 sekuntia. Lisäksi tulos näytti: "Nmap done: 11 IP addresses (4 hosts up)...". Eli skannaus tunnisti kuitenkin, mitkä hostit ovat ylhäällä. Testasin myöhemmin komennon ilman sudoa, jolloin tulos näytti siltä, kuin kaikki IP-osoitteet olisivat aktiivisena:

```console
jenni@hhpt:~$ nmap -Pn 192.168.60.0-10
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-04 18:31 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.0
Host is up.
All 1000 scanned ports on 192.168.60.0 are in ignored states.
Not shown: 1000 filtered tcp ports (no-response)
# tuloste lyhennetty, samat tiedot

Nmap scan report for 192.168.60.6
Host is up (0.00088s latency).
Not shown: 977 closed tcp ports (conn-refused)
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
23/tcp   open  telnet
25/tcp   open  smtp
53/tcp   open  domain
80/tcp   open  http
111/tcp  open  rpcbind
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
512/tcp  open  exec
513/tcp  open  login
514/tcp  open  shell
1099/tcp open  rmiregistry
1524/tcp open  ingreslock
2049/tcp open  nfs
2121/tcp open  ccproxy-ftp
3306/tcp open  mysql
5432/tcp open  postgresql
5900/tcp open  vnc
6000/tcp open  X11
6667/tcp open  irc
8009/tcp open  ajp13
8180/tcp open  unknown

# tuloste lyhennetty

Nmap done: 11 IP addresses (11 hosts up) scanned in 16.06 seconds
```
![-Pnnmap](https://github.com/jjenska/PenTest/assets/105623785/b7b01a53-079f-41d4-ab1b-8d390e67e25b)

Wiresharkissa näkyi, että paikallisessa verkossa tehdään ARP-tiedustelu, jonka jälkeen skannaus lähti lähettämään SYN-paketteja kohdeportteihin. En oikein osannut tulkita tuloksia tarkemmin, skannaus voisi vaatia kenties muun kuin paikallisen verkon, jotta isoja eroja syntyisi?

## g) nmap version detection -sV (esimerkki yhdestä palvelusta yhdessä portissa riittää)

```-sV``` (service & version detection) hyödyntää Nmapin tietokantaa, josta löytyy yli 2200 palvelua. Näin ollen Nmap ilmoittaa, että kyseiset portit kuten vaikka 80 vastaavat tiettyyn palveluun, esim. web-palvelimeen (HTTP). Tähän ei voi kuitenkaan tietoturvan näkökulmasta aina täysin luottaa, sillä palveluita voidaan ylläpitää myös erikoisissa porteissa. Version tunnistus auttaa palveluiden havoittuvuuksien tunnistamisessa, koska se näyttää versionumerot. *(man nmap)*

```console
jenni@hhpt:~$ sudo nmap -sV -p 80 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-03 15:25 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00020s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.2.8 ((Ubuntu) DAV/2)
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.40 seconds
```
Service-sarakkeessa näkyi palveluna http ja version-sarakkeessa Apache httpd 2.2.8 (Ubuntu), joka piti paikkansa. Tällä versiolla voisi kenties hakea, esim. millaisia haavoittuvuuksia siitä löytyy. Wiresharkin liikenteessä näkyi ensin ARP-tiedustelu, jonka jälkeen TCP-yhteyden avaus ja muodostaminen. Wireshark tallensi myös HTTP-liikennettä kuten GET ja POST-pyyntöjä. Rivillä 29 pyyntöön "GET /nmaplowerchech1699116456 HTTP/1.1." tuli vastauksena rivillä 35 virhe 404 "Not Found". Tätä en osannut analysoida tarkemmin. Rivin 73 GET-pyyntöön taas saatiin vastaus statuksella 200 (OK) rivillä 75. Tämän sisältö näytti wiresharkissa Metasploitable:n kirjautumissivun.

![-sVp80](https://github.com/jjenska/PenTest/assets/105623785/2c266970-5965-44ee-ad2b-5dc1b9d87f2c)
![-sVp80http](https://github.com/jjenska/PenTest/assets/105623785/5f3b8a4c-8086-4d6d-ac97-1a5ea5811953)

## h) nmap output files -oA foo. Miltä tiedostot näyttävät? Mihin kukin tiedostotyyppi sopii?

Voidaan määrittää tiedostonimi, esim. itselläni ```-oA scanData```, jolloin Nmap tallentaa tulokset scanData.nmap, scanData.gnmap ja scanData.xml tiedostomuodoissa *(man nmap)*. Alla oleva .nmap-tiedostotyyppi tulostaa jokaisen skannauksen tiedon omalle rivilleen. Tämä tekee siitä helppolukuisen, jolloin sitä voisi hyödyntää esim. raportoinnissa. Skannaukseen käytin kommentissa näkyvää komentoa: 
```$ sudo nmap -oA scanData 192.168.60.60```.

```console
jenni@hhpt:~$ cat scanData.nmap
# Nmap 7.93 scan initiated Fri Nov  3 16:15:50 2023 as: nmap -oA scanData 192.168.60.6
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.000094s latency).
Not shown: 977 closed tcp ports (reset)
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
23/tcp   open  telnet
# ...
# jatkuu useampi rivi
```
Tiedosto .gnmap näyttää kaiken sisällön putkeen kirjoitettuna, xml-tiedostoa voisi käyttää esim. tiedon analysoimiseen, kun tarvitsee ajaa paljon dataa ohjelmalla.

## i) nmap ajonaikaiset toiminnot (man nmap: runtime interaction): verbosity v/V, help ?, packet tracing p/P, status s (ja moni muu nappi)

Nmapin ajon aikana, kaikki näppäimien painallukset otetaan huomioon. Tämä mahdollistaa vuorovaikutuksen ohjelman kanssa, ilman, että sitä täytyy pysäyttää ja käynnistää uudelleen. Pienellä kirjoitetut kirjaimet nostavat tulostuksen määrää, isolla taas pienentävät. Apunappina toimii "?", joka ajon aikana antaa lisätietoikkunan. (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

```v / V``` = lisää / laske verbositeettiä (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

```d / D``` = lisää / laske debuggausen tasoa (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

```p / P``` = aseta päälle / pois pakettien jäljitys (*[man - runtime interaction](https://nmap.org/book/man-runtime-interaction.html)*)

Esimerkiksi "?" painaminen kesken skannauksen, antoi valikon "Interactive keyboard commands", josta näki ohjeet, miten debuggauksen ja verbositeetin tasoja voidaan nostaa/laskea.

```console
jenni@hhpt:~$ sudo nmap -sV 192.168.60.6
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-04 19:07 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Interactive keyboard commands:
?               Display this information
v/V             Increase/decrease verbosity
d/D             Increase/decrease debugging
p/P             Enable/disable packet tracing
anything else   Print status
More help: https://nmap.org/book/man-runtime-interaction.html
Nmap scan report for 192.168.60.6
Host is up (0.000067s latency).
Not shown: 977 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 2.3.4
22/tcp   open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
23/tcp   open  telnet      Linux telnetd
# ...

MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)
Service Info: Hosts:  metasploitable.localdomain, irc.Metasploitable.LAN; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.48 seconds
```
Kokeilemalla packet tracing enabled "p", listasi skannaus lähetettyjen ja saatujen pakettien tarkemmat tiedot terminaaliin. Esimerkiksi GET-pyynnön status 200 OK.

```console
NSE: TCP 192.168.60.4:51558 < 192.168.60.6:80 | HTTP/1.1 200 OK
Date: Sat, 04 Nov 2023 17:10:37 GMT
Server: Apache/2.2.8 (Ubuntu) DAV/2
X-Powered-By: PHP/5.2.4-2ubuntu5.10
Content-Length: 891
Connection: close
Content-Type: text/html

<html><head><title>Metasploitable2 - Linux</title></head><body>
<pre>

                _                  _       _ _        _     _      ____  
 _ __ ___   ___| |_ __ _ ___ _ __ | | ___ (_) |_ __ _| |__ | | ___|___ \ 
| '_ ` _ \ / _ \ __/ _` / __| '_ \| |/ _ \| | __/ _` | '_ \| |/ _ \ __) |
| | | | | |  __/ || (_| \__ \ |_) | | (_) | | || (_| | |_) | |  __// __/ 
|_| |_| |_|\___|\__\__,_|___/ .__/|_|\___/|_|\__\__,_|_.__/|_|\___|_____|
                            |_|                                          


Warning: Never expose this VM to an untrusted network!

Contact: msfdev[at]metasploit.com

Login with msfadmin/msfadmin to get started
```

## j) Ninjojen tapaan. Piiloutuuko nmap-skannaus hyvin palvelimelta? Vinkkejä: Asenna Apache. Aja nmap-versioskannaus -sV tai -A omaan paikalliseen weppipalvelimeen. Etsi Apachen lokista tätä koskevat rivit. Wiresharkissa "http" on kätevä filtteri, se tulee siihen yläreunan "Apply a display filter..." -kenttään. Nmap-ajon aikana p laittaa packet tracing päälle. ~Vapaaehtoinen lisäkohta: jääkö Apachen lokiin jokin todiste nmap-versioskannauksesta?~

Apache oli jo valmiiksi asennettuna, joten tein skannauksen:

```console
$ sudo nmap -A -p 80 localhost
```
Tämän jälkeen lähdin katsomaan Apachen lokitiedostoja, joista Nmap-skannaus oli aika selkeästi tunnistettavissa. Esimerkiksi ensimmäisellä rivillä näkyy HTTP GET-pyyntö, ja perässä Nmap Scripting Engine:

```console
jenni@hhpt:~$ sudo tail /var/log/apache2/access.log
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "GET / HTTP/1.1" 200 10975 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "OPTIONS / HTTP/1.1" 200 181 "-" "Mozilla/5.0 (compatible; Nmap Scripting Engine; https://nmap.org/book/nse.html)"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "GET / HTTP/1.0" 200 10975 "-" "-"
127.0.0.1 - - [04/Nov/2023:19:22:24 +0200] "GET / HTTP/1.1" 200 10956 "-" "-"
```

## k) UDP-skannaus. UDP-skannaa paikkalinen kone (-sU). "Mulla olis vitsi UDP:sta, mutta en tiedä menisikö se perille":

Testasin skannausta:
```console
$ sudo nmap -sU 192.168.60.6 --reason
```
Tämä jäi pyörimään, joten keskeytin ```ctrl``` + ```c``` noin minuutin kuluttua. Päätin testata, mikäli skannauksen saisi onnistumaan rajaamalla skannattavien UDP-porttien määrää *([man - port specification](https://nmap.org/book/man-port-specification.html))*. Tulos saatiin top 100:

```console
jenni@hhpt:~$ sudo nmap -sU 192.168.60.6 --reason --top-ports 100
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-04 17:53 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up, received arp-response (0.00022s latency).
Not shown: 93 closed udp ports (port-unreach)
PORT     STATE         SERVICE     REASON
53/udp   open          domain      udp-response ttl 64
68/udp   open|filtered dhcpc       no-response
69/udp   open|filtered tftp        no-response
111/udp  open          rpcbind     udp-response ttl 64
137/udp  open          netbios-ns  udp-response ttl 64
138/udp  open|filtered netbios-dgm no-response
2049/udp open          nfs         udp-response ttl 64
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 98.54 seconds
```

Tähänkin kului aikaa yli minuutin verran. --reason flagilla nähdään nyt vastauksen tila. Vertauksena haku komennolla:

```console
$ sudo nmap -sU 192.168.60.6 --top-ports 50
```
```console
jenni@hhpt:~$ sudo nmap -sU 192.168.60.6 --top-ports 50
Starting Nmap 7.93 ( https://nmap.org ) at 2023-11-04 18:07 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.6
Host is up (0.00021s latency).
Not shown: 43 closed udp ports (port-unreach)
PORT     STATE         SERVICE
53/udp   open          domain
68/udp   open|filtered dhcpc
69/udp   open|filtered tftp
111/udp  open          rpcbind
137/udp  open          netbios-ns
138/udp  open|filtered netbios-dgm
2049/udp open          nfs
MAC Address: 08:00:27:2B:78:A9 (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 60.57 seconds
```
![-sU-top100](https://github.com/jjenska/PenTest/assets/105623785/2758a619-6f22-44ca-8af2-a8baf6bb0f96)

Wireshark näytti, että molemmissa skannauksissa saatiin useampi "port unreachable" ICMP-viesti.

## l) Miksi UDP-skannaus on hankalaa ja epäluotettavaa? Miksi UDP-skannauksen kanssa kannattaa käyttää --reason flagia ja snifferiä?

Avoimet tai filtteröidyt portit harvoin lähettävät vastausta, jolloin Nmap aikakatkaisee yhteyden ja yrittää ohjata liikennettää uudelleen varmuudeksi, mikäli tiedustelu tai vastaus mahdollisesti hukattiin. Tämä myös tekee skannauksesta hidasta. *(man nmap)*

Suljetut portit saattavat olla vielä suurempi ongelma. Ne usein lähettävät "ICMP port unreachable" -virheen. Syn-skannauksessa RST-paketit lähetetään vastauksena suljetuista TCP porteista, mutta monet hostit rajoittavat ICMP porttien viestejä oletusarvoisesti. Nmap tunnistaa rajoituksen ja hidastaa skannausta välttääkseen verkon ruuhkauttamisen turhilla paketeilla, jotka kohdekone pudottaa. *(man nmap)*

--reason flag voi helpottaa porttien tilojen syiden määritystä. *[port scanning options](https://nmap.org/book/port-scanning-options.html)*

## Lähteet

[Adamtlangley - ffufme ](https://github.com/adamtlangley/ffufme.git)

[Baledung - handshakes](https://www.baeldung.com/cs/handshakes)

[Ffuf](https://github.com/ffuf/ffuf.git)

Nmap manual (man nmap)

[Nmap manual - Port Specification](https://nmap.org/book/man-port-specification.html)

[Nmap manual - Runtime Interaction](https://nmap.org/book/man-runtime-interaction.html)

[Nmap manual - Port Scanning Basics](https://nmap.org/book/man-port-scanning-basics.html)

[Nmap - Port Scanning Options](https://nmap.org/book/port-scanning-options.html)

[Nmap - Port Scanning Techniques](https://nmap.org/book/man-port-scanning-techniques.html)

[Tero Karvinen - Ethical Haching 2023](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h2-sniff-n-scan)

[Tero Karvinen - Fuzzing urls](https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/)

[Tero Karvinen - Ffufme web fuzzing target](https://terokarvinen.com/2023/fuffme-web-fuzzing-target-debian/)
