# h6 Attaaack

Tehtävien tekemiseen käytettiin pöytäkonetta:

- Prosessori: AMD Ryzen 5 3600 6-Core Processor 3.59 GHz
- Kovalevy: 256 GB M.2 SSD, 512 GB SSD
- Muisti: 32GB RAM
- Käyttöjärjestelmä: Windows 10 Pro
- VirtualBox
  
Lisäksi virtuaalikoneita: Kali Linux (valmis paketti, oletusasetuksilla), Metasploitable2

Tarkemmat tehtävänannot osoitteessa *[terokarvinen.com](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h6-attaaack)*
## x) Lue/katso/kuuntele ja tiivistä. 

Yehoshua and Kosayev 2021: Antivirus Bypass Techniques, luku: Chapter 1: Introduction to the Security Landscape
- haittaohjelmia on lukuisia: esim. virukset, madot, piilohallintaohjelmat, kiristysohjelmat...
- ohjelmat voivat toteuttaa useaa eri määritelmää:
    - esim. kiristysohjelman päätarkoitus on salakirjoittaa käyttäjän tiedostot lunnaita vastaan
    - ohjelma voi toimia myös troijalaisena ja matona, mikäli se pystyy liikkumaan verkossa sivusuuntaisesti saastuttaen muita koneita (esimerkkinä kirjassa WannaCry)
- Antivirusohjelman lisäksi käyttäjää/yritystä voidaan suojata useilla menetelmillä:
    - EDR (endpoint detection and response): reaaliaikaiset vastaukset jokaisesta tapahtumasta, joka määritellään haitalliseksi
    - palomuuri: verkossa tapahtuvien uhkien monitorointi, esto ja tunnistaminen perustuen ennalta määrättyihin käytäntöihin
    - IDS/IPS (intrusion detection system/intrusion prevention system): tutkitaan verkkotason paketteja, ja etsitään haitallisia polkuja/kaavoja
    - DLP (data loss prevention): pysäytetään ja raportoidaan, mikäli arkaluontoista dataa on vuotamassa valtuuttamattomille tahoille
- antivirusohjelmat voidaan luokitella: static, dymanic, heuristic ja unpacking
- staattinen heikoin, vertaa käyttöjärjestelmän tiedostoja (.EXE,.DLL jne.) tietokannan sisältämiin "signatuureihin", ja sitä kautta tunnistaa haittoja
- heuristic edistynyt, määrittelee tiedostoille tuloksen/pistemäärän (score) keräämällä tilastollista analyysiä, joka yhdistää staattisen ja dyynaamisen keinot
- antivirusohjelma voidaan kiertää TCP-protokollaa hyödyntäen reverse shell ja blind shell keinoin (kyseisen kirjan testaus tehty lähiverkossa)
    - reverse shell: hyökkääjän koneelle määritellään portti, joka on auki C2 serverillä, haittaohjelma toimii clientina, joka avaa yhteyden hyökkääjän C2 serverille käyttäen sattumanvaraista porttia, joka avataan kohteen päässä  

*LÄHDE*

Halonen, Rajala ja Ollikainen 2023: PhishSticks Youtube Channel, kahdeksan videota, yhteensä noin 15 min
- haittaohjelman testaaminen sovelluskansion sisällä: listataan tiedostot ja avataan .txt ja .jpg &rarr; ajetaan python skripti, jonka jälkeen kaikki tiedotot on salakirjoitettu
- digisparkin testaaminen: laitteen asettaminen koneeseen käynnistää haittaohjelman automaattisesti, joten tiedostot Documents-kansiossa salataan
- keyloggerin testaaminen: käyttäen digisparkia injektoidaan komento, joka lataa uhrin koneella PowerShell skriptin ja ajaa sen taustalla, tämä tekee automaattisesti POST pyynnön etäserverille log-tiedoston sisällöstä &rarr; pyyntö hyväksytään ja tiedot tallennetaan

Halonen, Rajala ja Ollikainen 2023: PhishSticks Git Repository, sivut:
README.md
...
  
Revshell
- Company raport tiedosto on linkitetty piilotettuun kansioon payload\
  &rarr; raportti avataan, jolloin ladataan netcat hyökkääjän IP-osoitteesta\
  &rarr; reverse shell käynnistetään
  
Mitigations
- PowerShellin käytön pois päältä kytkeminen estää Digisparkin hyötykuormien ajon:
    &rarr; User Configurations välilehdeltä Administrative Templates ja System voidaan asettaa mitä Windows sovelluksia ei ajeta
- Voidaan myös asettaa Windowsin palomuurin sääntöihin, jolloin ajo estetään
- Tehokas tapa on kytkeä "Run" pois päältä käyttäjällä, tämä mahdollistaa silloin PowerShellin käytön
  
Installing Windows 10 on a virtual machine
- Microstoftin sivuilta mahdollista ladata .iso tiedosto
- versioksi Windows 10 (64-bit)
- VirtualBox Disk Image kovalevyn tyypiksi ja dynamically allocated
- prosessoreiden määräksi väh. 4 kpl
- custom asennus ja domain join ilman Microsoft käyttäjätiliä

*[Halonen, Rajala ja Ollikainen - PhishSticks](https://github.com/therealhalonen/PhishSticks/)*

MITRE Att&ck Frequently Asked Questions: Part 1. General.

- ATT&CK on tietoalusta kyberhyökkääjien toiminnasta, keskittyy dokumentoimaan toimet ja käyttäytymisen koko kyberhyökkäyksen elinkaaren ajan
- Enterprise keskittyy yritysverkkoihin ja pilveen kohdistuvaan toimintaan, Mobile mobiililaitteisiin kohdistuvaan
- tactics (toimenpiteet/taktiikat) = keskittyvät kuvaamaan miksi hyökkääjällä on tietty suoritustapa tai sen aliluokka &rarr; on syy suorittaa tietty toimi, jotta päästään tavoitteeseen
- techniques (suoritustavat/tekniikat) = keskittyvät kuvaamaan miten hyökkääjä saavuttaa toimenpiteensä (tactic) maalin (esim. aktiivinen skannaaminen)
- prosedures (menetelmät) = keskittyvät kuvaamaan tiettyä suoritustavan tai sen aliluokan toteutusta, jota hyökkääjä käyttää\
    &rarr; esim. Volatile Cedar on käyttänyt DirBusteria ja GoBusteria brute force hyökkäämällä web hakemistoihin ja DNS aliverkkotunnuksiin (subdomains)

MITRE Att&ck Enterprise Matrix (muutama esimerkki)
- Persictense: Modify Authentication Process (T1556):
    - hyökkääjät voivat muokata autentikointi menetelmiä ja prosesseja päästäkseen käsiksi käyttäjätunnuksiin, menetelmiä ovat mm. Windowsilla LSASS (Local Security Authentication Server) ja SAM (Security Accounts Manager)
    - 8 alitekniikkaa: Domain Controller Authentication, Password Filter DLL, Network Device Authentication, Reversible Encryption, Multi-Factor Authentication, Hybrid Identity, Network Provider DLL
    - hyökkääjistä Ebury voi siepata yksityisiä avaimia käyttämällä ssh-add funktiota (trojanized)
    - estokeinoja esim. monivaiheinen tunnistus

## a) Asenna Windows virtuaalikoneeseen samaan verkkoon hyökkäyskoneen kanssa. Kokeile, että saat koneen irrotettua Internetistä.

### Asennus

Seurasin asennuksessa Ollikaisen PhisSticks repon *[ohjeita](https://github.com/therealhalonen/PhishSticks/blob/master/notes/ollikainen/windows.md)*.

Aloitin lataamalla ISO-tiedoston (Enterprise downloads: English Great Britain, 64-bit) Microsoftin *[sivuilta](https://www.microsoft.com/en-us/evalcenter/download-windows-10-enterprise)*.

![vm1](https://github.com/jjenska/PenTest/assets/105623785/df5078e6-00d3-4230-8350-ab85675ad458)

Latauksen valmistuttua siirryin VirtualBoxiin ja klikkasin sieltä ylärivistä "New". Syötin koneen nimeksi haluamani, tyyppi ja versio olivat VirtualBoxissa jo oletuksena Microsoft Windows ja Windows 10 (64-bit), kuten kuvassa näkyy:

![vm2](https://github.com/jjenska/PenTest/assets/105623785/9a6e0c86-3edb-46d1-b200-fb90708a417c)

Tämän jälkeen klikkasin "Next" ja asetin muistimääräksi 8000MB, sekä prosessorien määräksi 4kpl, kuten Ollikainen ohjeessa suositteli. Windows ilmeisesti vaatii enemmän muistia ja prosessoreita pyöriäkseen tehokkaammin, kuin esim. Debian.

![vm3](https://github.com/jjenska/PenTest/assets/105623785/c9b19de9-65fe-41d4-ab09-26ae4e2449c1)

Sen jälkeen siirryin seuraavaan ikkunaan, jossa loin virtuaalisen kovalevyn. Ohjeissa koneen koko oli 50GB, mutta päädyin itse asettamaan 30GB. Tarvisin konetta vain tulevaa tehtävää varten, joten uskoin sen riittävän tarpeisiini. 

![vm4](https://github.com/jjenska/PenTest/assets/105623785/95bcf01e-99ce-4638-8c45-4f9ec0679d0e)

Tämän jälkeen tuli yhteenvetoikkuna, josta klikkasin "Finish". Tämän jälkeen asetin virtuaalisen levyn asemaan, eli luodun Windows koneen asetuksista "Settings" -> "Storage", josta klikkasin sinistä levyn kuvaa ja oikealta toista levyn kuvaa "Optical Drive" -valikosta "Choose/Create a Virtual Optical Disk...". 

![vm6](https://github.com/jjenska/PenTest/assets/105623785/383ae139-8792-4df3-89b8-de522014b87b)

Tämän ikkunan auettua valitsin vasemmalta ylhäältä "Add", ja etsin hakemistosta kansion, johon olin ladannut ISO-tiedoston. Sen jälkeen klikkasin oikean tiedoston kohdalla ja alhaalta "Choose". Tämän jälkeen oli aika käynnistää kone. Ensimmäisenä asennusohjelma kysyi asennuksen kieltä, aikavyöhykettä ja näppäimistön kieliasetusta. Asennuksen oletuksena sai olla englanti, aikavyöhykkeeksi valitsin Suomen, jolloin myös näppäimistö vaihtui automaattisesti suomeksi.

![vm7](https://github.com/jjenska/PenTest/assets/105623785/2646fec4-28a2-423f-8972-3f81e57a732c)

Klikkaamalla "Next" ja "Install now", sain vielä ikkunan, jossa pyydettiin hyväksymään lisenssin ehdot. Raksin ruudun, että hyväksyn ja "Next". Tämän jälkeen oli vaihtoehtona "Upgrade" tai "Custom", valitsin ohjeen mukaan Custom, koska ei ollut aikaisempaa versiota päivitettävänä. Tämän jälkeen ohjelma kysyi, mihin haluan asentaa Windowsin. Vaihtoehtona oli vain luomani virtuaalinen kovalevy: 

![vm8](https://github.com/jjenska/PenTest/assets/105623785/972a5389-43e6-4326-ba3e-2d19ef0efb38)

Tämän valittuani, lähti asennus pyörimään, jossa kestikin tovi. Asennuksen valmistuttua, Windows varmisti, että alueeni on Suomi.

![vm9](https://github.com/jjenska/PenTest/assets/105623785/96812e58-b059-4f9a-a5f2-09a54b46c2a7)

Tämän jälkeen Windows pyysi vielä näppäimistön kielen uudelleen, lisäksi tiedusteli haluaisinko myös lisätä vaihtoehtoisen näpääimistön. Tähän skip.

![vm10](https://github.com/jjenska/PenTest/assets/105623785/fc0a4b35-d52f-4024-b8a3-a7118b56aea5)

Vihdoin pääsin luomaan käyttäjän, ensisijaisesti Windows tosin tarjosi kirjautumista Microsoft käyttäjällä. Alhaalta vasemmalta löytyi kuitenkin "Domain join instead", joka johti tavallisen käyttäjätilin luontiin.

![vm11](https://github.com/jjenska/PenTest/assets/105623785/a0933849-9db0-4314-93fd-99e1c5ae7f02)
![vm12](https://github.com/jjenska/PenTest/assets/105623785/fbcfbded-11c3-4eb9-9da5-f456208e2831)

Käyttäjänimen syöttämisen jälkeen täytyi luoda vahva salasana, jonka jälkeen vielä valita 3 eri turvakysymystä valmiiksi annetuista vaihtoehdoista, ja niihin tietysti omat vastaukset.

![vm13](https://github.com/jjenska/PenTest/assets/105623785/ef5acaaf-5c7b-4a48-ba51-e36075528766)

Vastaan tuli vielä useampi kysymys mm. sijaintitietojen käytöstä, ja muusta käyttäjädatan hyödyntämisestä. Näihin valitsin ei kiitos, tai minimivaatimukset:

![vm14](https://github.com/jjenska/PenTest/assets/105623785/8b987c2c-4f21-46ec-86f1-a6b6432e12d8)

Pienen odottelun jälkeen kaikki oli vihdoin valmista:

![vm15](https://github.com/jjenska/PenTest/assets/105623785/11c6579a-9494-4aab-98cc-d2eabc3b440d)

### Virtuaaliverkko ja Windowsin internetyhteyden tarkistus

Loin Kalille ja Windowsille oman virtuaaliverkon. Tämä tapahtui VirtualBoxin valikosta "Tools" -> "Network" -> "Host-only Networks" -> "Create". Molempien koneiden asetuksista siirryin Network-välilehdelle, josta asetin "Host-only Adapter".

![vm16](https://github.com/jjenska/PenTest/assets/105623785/09cdde63-d8c2-49e1-a18b-d91beb3124b5)

Käynnistin molemmat koneet, ja tarkistin ensin Kalin IP-osoitteen:

```console
┌──(kali㉿kali)-[~]
└─$ ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        # ei tarvetta tälle (NAT)

eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        # tässä verkossa Metasploitable2

eth2: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.144.4  netmask 255.255.255.0  broadcast 192.168.144.255
        inet6 fe80::811a:420c:e5a7:dae7  prefixlen 64  scopeid 0x20<link>
        ether 08:00:27:08:95:ee  txqueuelen 1000  (Ethernet)
        RX packets 32  bytes 6222 (6.0 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 24  bytes 3426 (3.3 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 4  bytes 240 (240.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 4  bytes 240 (240.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

Tämän jälkeen siirryin Windowsin komentokehotteeseen. GitHub repon asennusohjeissa näkyikin komento, miten Windowsin IP-osoitetiedot tarkistetaan (```ipconfig```). Tämän jälkeen kokeilin pingata Kalin, ja yhteys näytti toimivan, sillä kaikki paketit päätyivät perille:

![vm17](https://github.com/jjenska/PenTest/assets/105623785/a9dd568e-45d5-4409-8993-e4006f7a9188)

Kalilta pingaaminen ei onnistunut, sama ongelma oli repon asennusohjeessa, jossa epäiltiin sen johtuvan Windowsin turvallisuusasetuksista. Tarkistin vielä Windowsin yhteyden nettiin pingaamalla DNS-palvelimen osoitteen 8.8.8.8.

![vm18](https://github.com/jjenska/PenTest/assets/105623785/1dc6d30e-6175-48bd-99b3-e558547d7580)

Yhteys ei ollut toiminnassa, navigoin vielä Edge-selaimeen ja sieltä Googleen, joka varmisti saman.

![vm18](https://github.com/jjenska/PenTest/assets/105623785/a2476ae5-032d-4eed-8182-acf7728ac125)

## b) Kokeile PhishSticksin revshell vihamielistä tiedostoa, joka avaa käänteisen shellin hyökkääjän koneelle. Selitä, mitä tapahtuu ja miksi. Testaa, että pysyt antamaan kohdekoneelle komentoja reverse shellin kautta.
## d) Laita linkki raporttiisi kurssisivun kommentiksi.

## c) MITRE Attack Enterprise Matrix: Demonstroi viisi tekniikkaa viidestä eri taktiikasta. (Nimeä käytetyt taktiikat, tekniikat ja alitekniikat. Merkitse myös niiden numerot)

### Taktiikkana Recoinnaissance
#### Tekniikkana Active Scanning

#### T1595.001	Scanning IP Blocks

Hyökkääjät voivat skannata kohteen IP-lohkoja, joista voi olla hyötyä kohdistettuun hyökkäykseen. Julkisia IP-osoitteita voidaan jakaa organisaatiolle lohkona tai peräkkäisenä osoiteavaruutena *([Mitre - Scanning IP Blocks](https://attack.mitre.org/techniques/T1595/001/))*. Tehtävää varten minulla oli käytössä host-only virtuaaliverkko Kalin ja Metasploitable2 välillä. Ajatuksena oli, että hyökkääjällä olisi tietty kohdeosoitealue, jota skannata, ja selvittää samalla, onko IP-osoite ylipäätään ylhäällä. Skannaus on kevyempi, koska se ei tee porttiskannausta, ja tapahtuu melko huomaamattomasti. Hyökkääjälle arvokasta tietoa on, mitkä hostit ovat ylhäällä.

```console
┌──(kali㉿kali)-[~]
└─$ sudo nmap -sn 192.168.60.0/24
[sudo] password for kali: 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-12-01 18:31 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.1
Host is up (0.00016s latency).
MAC Address: 08:00:27:93:8F:57 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.60.8
Host is up (0.00023s latency).
MAC Address: 08:00:27:D4:7A:6C (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.60.7
Host is up.
Nmap done: 256 IP addresses (3 hosts up) scanned in 2.31 seconds
```

Skannauksen avulla sai selville, että yhteensä 3 hostia on ylhäällä. Näistä ensimmäinen on DHCP-palvelimen, toinen Metasploitable2:n ja kolman skannauksen tehdyn Kalin. Tässä tapauksessa hyökkääjälle kiinnostava kohde olisi tuo ```.8``` päätteinen IP, jolle voisi tehdä tarkemman skannauksen esim. versioista (```-sV```). 

#### T1595.002	Vulnerability Scanning

Uhreja voidaan myös skannata haavoittuvuuksien selvittämiseksi. Näitä voidaan käyttää kohdistetussa hyökkäyksessä. Haavoittuvuusskannaukset yleensä tarkistavat, vastaako kohteen isäntäsovelluksen konfiguraatio (esim. ohjelmisto ja versio) mahdollisesti tiettyä hyökkäystä, jota hyökkääjä saattaa yrittää käyttää. Haavoittuvuusskannaukset keräävät yleensä käynnissä olevan ohjelmiston ja versionumerot esim. palvelimen bannereista tai kuuntelevista porteista. *([Mitre - Vulnerability Scanning](https://attack.mitre.org/techniques/T1595/002/))* Tähän tarkoitukseen hyödynsin Nmap:n "agressiivista" skannausta (```-A```), joka näyttää portit, ja niissä olevien palveluiden versiot.

```console
┌──(kali㉿kali)-[~]
└─$ sudo nmap -A 192.168.60.8  
Starting Nmap 7.94SVN ( https://nmap.org ) at 2023-12-01 18:38 EET
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.60.8
Host is up (0.00023s latency).
Not shown: 977 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 2.3.4
# tulosteen rivejä poistettu
....
3306/tcp open  mysql       MySQL 5.0.51a-3ubuntu5
| mysql-info: 
|   Protocol: 10
|   Version: 5.0.51a-3ubuntu5
|   Thread ID: 9
|   Capabilities flags: 43564
|   Some Capabilities: Support41Auth, SupportsCompression, ConnectWithDatabase, LongColumnFlag, SwitchToSSLAfterHandshake, Speaks41ProtocolNew, SupportsTransactions
|   Status: Autocommit
|_  Salt: d|aRXB~uRy-m`yb_710=
# tulosteen rivejä poistettu
```
Tässä otin tarkasteluun portissa 3306 auki olevan MySQL:n, versionumerona 5.0.51a. Kokeilin hakea haavoittuvuutta suoraan Googlesta "MySQL 5.0.51s exploit". Tällä ensimmäinen tulos ohjasi suoraan *[Exploit Databaseen](https://www.exploit-db.com/exploits/23077)*, josta selviää, että kyseisen näin kyseistä haavoittuvuutta voidaan hyödyntää luomalla uusi admin käyttäjä MySQL tietokantaan.

#### T1595.003	Wordlist Scanning

Tämä tekniikka käyttää samankaltaisia menetelmiä kuin brute force, mutta sen tarkoituksena on tunnistaa sisältöä ja infrastruktuuria sen sijaan, että etsittäisiin käyttökelpoisia tunnistetietoja (esim. käyttäjänimi + salasana). Näissä skannauksissa käytetyt sanalistat voivat sisältää yleisiä, yleisesti käytettyjä nimiä ja tiedostopäätteitä tai termejä, jotka ovat tyypillisiä tietylle ohjelmistolle. Esimerkiksi hyökkääjät voivat käyttää työkaluja kuten Dirb, DirBuster ja GoBuster löytääkseen web-sisältöä. Lisäksi he voivat hyödyntää yleisiä tai räätälöityjä sanalistoja listatakseen verkkosivuston/sovelluksen sivuja ja hakemistoja. *([Mitre - Wordlist Scanning](https://attack.mitre.org/techniques/T1595/003/))*

Tässä tehtävässä päätin hyödyntää Metasploitable2:stakin löytyvää Damn Vulnarable Web Application verkkosovellusta. Päätin kokeilla asentaa sen Kalille. GitHub *[reposta](https://github.com/digininja/DVWA)* löytyi *[ohjevideo](https://www.youtube.com/watch?v=WkyDxNJkgQ4)*, jota seurasin asennuksessa. Sovelluksen olisi vaihtoehtoisesti voinut ajaa Dockerilla.

Ensin kloonasin repon koneelleni

```console
┌──(kali㉿kali)-[~]
└─$ git clone https://github.com/digininja/DVWA.git    
```
Ensin sovellus täytyi siirtää Apachen hakemiston juureen, eli ```/var/www/html```. Kalissa oli Apache valmiina asennettuna.

```console
┌──(kali㉿kali)-[~]
└─$ sudo mv DVWA /var/www/html/    
```
Sitten siirryin kyseiseen hakemistoon ja käynnistin Apachen palvelimen.

```console
┌──(kali㉿kali)-[~]
└─$ sudo service apache2 start 
```
Palvelimen käynnistys ei ilmoittanut mitään, joten navigoin localhostiin, jotta näin oliko se toiminnassa. Apachen etusivu tuli näkyviin, joten se oli käynnissä. Tämän jälkeen testasin polkua ```localhost/DVWA/```. 

![dvwa1](https://github.com/jjenska/PenTest/assets/105623785/79fc303b-4b0b-4e28-87ce-7056511774fc)

Ilmoituksena tuli, että konfiguraatiotiedostoa ei löydy. Täytyi siis kopioida ````config/config.inc.php.dist``` tiedostoon ```config/config.inc.php```, jotta voidaan konfiguroida oma ympäristö. Tämä estää, että käyttäjät eivät vahingossa päivitä omia muutoksiaan (kuten tietokannan salasanoja) GitHubin repoon. Toimin siis ohjeen mukaan:


```console
┌──(kali㉿kali)-[/var/www/html/DVWA]
└─$ ls config 
config.inc.php.dist
                                                                             
┌──(kali㉿kali)-[/var/www/html/DVWA]
└─$ cp config/config.inc.php.dist config/config.inc.php
```
Sitten avasin konfiguraatiotiedoston, jotta pystyin tarkastelemaan sen sisältöä. Tietokannaksi oli määritelty MySQL, serveriksi localhost eli 127.0.0.1. Lisäksi tuolta löytyivät tietokanta & käyttäjä "dvwa" ja salasana "p@ssw0rd". Tietokantapalvelu ei ollut vielä toiminnassa, joten avasin palvelimen ```sudo service mariadb start```. GitHub reposta löytyi tiedot, että koska MariaDB on oletuksena Kalissa (ei MySQL), täytyy siihen luoda uusi käyttäjä. Tietokantaan piti yhdistää root:na, ja ajaa GitHubiin annetut komennot. Avasin erillisen terminaalin, jossa kirjauduin ensin "as root". Komennoksi annettiin "mysql", vaikka kyseessä on MariaDB (miksi näin, jäi hieman epäselväksi).

```console
┌──(kali㉿kali)-[~]
└─$ sudo su -      
[sudo] password for kali: 
┌──(root㉿kali)-[~]
└─# mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 31
Server version: 10.11.5-MariaDB-3 Debian n/a

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> 
```
Tämän jälkeen kopioin jokaisen komennon järjestyksessä GitHub:n reposta, ja tarkistin, että saan vastaukseksi "Query OK".

```console
MariaDB [(none)]> create database dvwa;
Query OK, 1 row affected (0.006 sec)

MariaDB [(none)]> create user dvwa@localhost identified by 'p@ssw0rd';
Query OK, 0 rows affected (0.005 sec)

MariaDB [(none)]> grant all on dvwa.* to dvwa@localhost;
Query OK, 0 rows affected (0.029 sec)

MariaDB [(none)]> flush privileges;
Query OK, 0 rows affected (0.002 sec)

MariaDB [(none)]> ^DBye
```

Käyttäjän pystyi vielä tarkistamaan kirjautumalla sisään.

```console
┌──(kali㉿kali)-[~]
└─$ mysql -u dvwa -p 
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 32
Server version: 10.11.5-MariaDB-3 Debian n/a

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> use dvwa;
Database changed
MariaDB [dvwa]> 
```

Kaikki näytti toimivan, joten siirryin localhostiin ja setup-sivulle ```/DVWA/setup.php```. Sieltä testasin klikkaamalla "create/reset database", joka antoi viestin, että tietokanta oli luotu. Tämän jälkeen sovellus ohjasi sisäänkirjautumissivulle.

![dvwa3](https://github.com/jjenska/PenTest/assets/105623785/cb211950-8bff-43cb-b876-16931067353d)

Kirjautumaan pääsi valmiiksi annetuilla tunnuksilla:

```
username: admin
password: password
```

![dvwa4](https://github.com/jjenska/PenTest/assets/105623785/de7c0849-a90e-4f3d-8e5f-e7c0e73a48d9)

Vihdoin pääsin itse tehtävään, eli päätin käyttää ffuf:a sovelluksen mahdollisten hakemistojen fussaamiseen. Päätin selvittää, löytyykö Kalista valmiiksi sanalistoja, ja löytyihän sieltä. *[Dokumentaation](https://www.kali.org/tools/wordlists/)* mukaan kaikki sijaitsevat hakemistossa ```/usr/share/wordlists```. Kokeilin tabulaattorilla eri kansioita, ja löysinkin tutun "common.txt". Päätin testata sitä. Asetin haettavien tiedostopäätteiden kriteeriksi ```.php```. 


```console
┌──(kali㉿kali)-[~]
└─$ ffuf -w /usr/share/wordlists/wfuzz/general/common.txt -u http://localhost/DVWA/FUZZ.php 

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://localhost/DVWA/FUZZ.php
 :: Wordlist         : FUZZ: /usr/share/wordlists/wfuzz/general/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

index                   [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 1ms]
logout                  [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 2ms]
login                   [Status: 200, Size: 1342, Words: 77, Lines: 75, Duration: 3ms]
security                [Status: 302, Size: 0, Words: 1, Lines: 1, Duration: 1ms]
setup                   [Status: 200, Size: 3743, Words: 296, Lines: 120, Duration: 1ms]
about                   [Status: 200, Size: 3727, Words: 265, Lines: 103, Duration: 4166ms]
:: Progress: [951/951] :: Job [1/1] :: 48 req/sec :: Duration: [0:00:04] :: Errors: 0 ::

```
Tässä tapauksessa hyökkääjää kiinnostaisi varmasti tiedosto "setup.php". Ja kuten jo sovelluksen asentamisessa näkyi, kyseisen sivun kautta pystyisi esimerkiksi resetoimaan tietokannan. 

#### Tekniikkana Gather Victim Identity Information
#### T1589.001	Credentials

Hyökkääjät voivat kerätä tunnistetietoja mahdollisilta uhreilta eri tavoin, kuten tietoja kalastelemalla. He voivat myös rikkoa sovelluksia lisäämällä niihin haitallista sisältöä, joka on suunniteltu keräämään verkkosivustolla vierailevien tunnistetietoja evästeiden avulla. *([Mitre - Credentials](https://attack.mitre.org/techniques/T1589/001/))* Tässä osiossa kävin läpi DVWA:n SQL-injection kohtaa, jossa piti löytää 5 käyttäjää, joiden ID:t olivat 1-5. En ole varma vastaako tämä täysin kyseistä tekniikkaa, mutta injektion avulla olisi mahdollista saada kenties käyttäjänimet ja salasanat. 

Kun tarkastelin tehtävän koodia klikkaamalla "View Source", huomasin, että käyttäjän syöttämää tietoa ei validoida mitenkään:

```php
// poistettu epäolennaiset rivit koodista
    // Get input
    $id = $_REQUEST[ 'id' ];

    switch ($_DVWA['SQLI_DB']) {
        case MYSQL:
            // Check database
            $query  = "SELECT first_name, last_name FROM users WHERE user_id = '$id';";
// poistettu epäolennaiset rivit koodista
```
Kokeilin ensin hakea normaalisti id:llä 1 yhden käyttäjän tiedot:

![cred1](https://github.com/jjenska/PenTest/assets/105623785/a7058a25-b105-4004-bec7-329e90b2d209)

Päätin kokeilla yksinkertaista syntaksia *[w3schools:n sivuilta](https://www.w3schools.com/sql/sql_injection.asp)* ```"oe" "="```. Se toimi, sillä sain kaikki käyttäjät tulostumaan sovellukseen.

![cred2](https://github.com/jjenska/PenTest/assets/105623785/9726b635-cb11-4d43-99ff-28fc62f6e9ee)

Katsoin annetusta vinkistä, että tässä tulisi käyttä ```UNION SELECT``` lausetta, jotta saataisiin myös mahdolliset salasanat näkyviin. Kokeilin Portswiggerissäkin käytettyä testiä ```'UNION SELECT+'aaa','bbb'--```, mutta sain Bupr:ssa "Internal Server Error". Kokeilin myös muuttaa syntaksia ilman "+" merkkiä, mutta tuloksetta. Päätin vilkaista, löytyisikö tehtävän ratkaisemiseen jonkinlaista ohjetta. Youtube *[tutoriaalista](https://www.youtube.com/watch?v=5bj1pFmyyBA)* löysin vastauksen, ja ainakin kommenttini syntaksissa oli pielessä. MariaDB käyttää kommenteissa merkkiä "#". Muutettuani sen, sain syntaksin palauttamaan jotain.

![cred3](https://github.com/jjenska/PenTest/assets/105623785/24869f49-a9dc-49c5-aac2-1ace27472843)

Tutoriaalissa hyödynnettiin myös suoraan Portswiggerin lausetta ```'UNION SELECT username,password FROM users#```. Kokeilin tätä, vaikka tiesin jo, että username ei ole oikea sarakkeen nimi. Tutorialissa tästä tuli virheviesti, mutta localhostini antoi vain viestin "This page isn't working" ja Burp "Internal Server Error". Tässä vaiheessa en ryhtynyt selvittämään, mistä johtui, ettei selaimeni ilmoittanut tarkempia virheilmoituksia. Kun muutin sarakkeen "username" -> "user", sain kaikki käyttäjät ja salasanat listautumaan oikein.

![cred4](https://github.com/jjenska/PenTest/assets/105623785/d07875e3-0c23-47b4-9793-52f46517fd3a)

Tässä tapauksessa First Name -sarakkeeseen näytti tulostuvan salasanan tiiviste, ja Surname kohtaan käyttäjän nimi. Tiivisteet voisi kokeilla vielä murtaa...

### Taktiikkana Credential Access

#### T1110 Brute force

#### T1110.001	Password Guessing

Hyökkääjät, joilla ei ole hallussaan käyttäjän tunnistetietoja, voivat arvata salasanoja yrittääkseen pääsyä käyttäjätilille. Hyökkääjä voi arvailla salasanoja hyödyntäen valmiita listoja yleisesti käytetyistä salasanoista. Tämä voi olla tosin riski, sillä useat yritykset saattavat johtaa käyttäjätilin lukkiutumiseen, riippuen organisaation kirjautumiskäytännöistä.

Löysin *[tutoriaalin](https://www.youtube.com/watch?v=2_lswM1S264)*, jossa hyödynnettiin Burp:n intruder-toimintoa. Päätin hyödyntää tätä DVWA:n Brute Force -tehtävässä. Ensin syötin sisäänkirjautumislomakkeeseen käyttäjänimen "user" ja salasanan "user". 

![brute1](https://github.com/jjenska/PenTest/assets/105623785/15c8db68-0b28-402c-ad69-e9551db0ef8e)

Tämän jälkeen nappasin pyynnön Burp:ssa, ja siirsin hiiren oikealla "send to intruder". Sieltä valitsin tässä tapauksessa arvoiksi sekä käyttäjänimen, että salasanan. Eli kuten kuvassa näkyy, maalattiin molemmat arvot ja klikattiin "add":

![brute2](https://github.com/jjenska/PenTest/assets/105623785/203d4ad2-65ae-44ed-bcab-58de027d5c4d)

Tämän jälkeen asetin hyökkäyksen tyypiksi "cluster bomb", jotta voisin asettaa useamman payloadin. 

![brute3](https://github.com/jjenska/PenTest/assets/105623785/516722ec-8750-47e5-9d98-5a893f4a7628)

Siirryin ylhäältä välilehdeltä payloads osioon, jossa ensimmäinen payload oli valmiiksi numerolla "1", ja tyyppinä "simple list". Tässä tapauksessa oli tarkoitus hyödyntää esim. valmiita sanalistoja, joten siksi tyyppinä tuo. Payloadin asetuksista pystyi latamaan joko valmiin sanalistan, tai lisäämään add-painikkeesta arvoja itse. Näin yksinkertaisessa esimerkissä asetin ainoastaan 4 eri arvoa (admin, administrator, user1, user).

![brute4](https://github.com/jjenska/PenTest/assets/105623785/c58b669c-f4f1-4321-b59f-b80387d711dc)

Tämän jälkeen valikosta vaihdettiin "payload set" numeroksi 2. Tyyppinä edelleen sama lista. Tätä varten latasin *[GitHub:sta](https://github.com/DavidWittman/wpxmlrpcbrute/blob/master/wordlists/1000-most-common-passwords.txt)* .txt tiedoston, johon oli listattu 1000 yleisintä salasanaa. Klikkasin siis payloadin asetuksista "load..." -> "open". 

![brute5](https://github.com/jjenska/PenTest/assets/105623785/1657ab5e-2850-448d-8acd-48e32a4de100)

Kun olin avannut tiedoston, klikkasin ylhäältä oikealta "start attack". 

![brute6](https://github.com/jjenska/PenTest/assets/105623785/5e2c874d-927d-4589-a499-ffc935af3d63)

Burp alkoi käydä läpi listoja, statuksella 200 tuli runsaasti vastauksia. 1000 sanan määrä oli myös täysin liioiteltua, koska tiedossa oli jo admin tunnuksen salasana, mutta tulipahan kokeiltua ominaisuus. Usean pyynnön pituus näytti olevan sama, eli 4618 tai 4617. Yksi poikkeus listalta kuitenkin löytyi: pituus 4660. Tämän kohdalla näkyi "admin" ja "password".

![brute7](https://github.com/jjenska/PenTest/assets/105623785/de3f6447-27ef-4df3-b16a-32b68006d19a)

Tämähän oli jo tiedossa, tarkistin kuitenkin vielä pyyntöön tulleen vastauksen, ja renderöin sen:

![brute8](https://github.com/jjenska/PenTest/assets/105623785/1006eb91-a1b4-4465-8ef9-9fc5b3b763f3)

Tässä tapauksessa hyödynsin sekä käyttäjätunnusta, että salasanaa. Mitren kuvaamassa tilanteessa hyökkääjällä todennäköisesti olisi jo lista käyttäjätunnuksista, joiden salasana voitaisiin yrittää arvata brute force hyökkäyksellä.

#### T1110.002	Password Cracking

#### T1539 Steal Web Session Cookie

# Lähteet:

[Exploit Database](https://www.exploit-db.com/exploits/23077)

[GitHub - DVWA repository](https://github.com/jjenska/PenTest/assets/105623785/79fc303b-4b0b-4e28-87ce-7056511774fc)

[GitHub - David Wittman: 1000 most common passwords](https://github.com/DavidWittman/wpxmlrpcbrute/blob/master/wordlists/1000-most-common-passwords.txt)

[Kali Linux - Tools: wordlists](https://www.kali.org/tools/wordlists/)

[Karvinen Tero - h6](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h6-attaaack)

[Halonen, Rajala ja Ollikainen - PhishSticks](https://github.com/therealhalonen/PhishSticks/)

[Ollikainen - PhishSticks: installing Windows 10 on a virtual machine](https://github.com/therealhalonen/PhishSticks/blob/master/notes/ollikainen/windows.md)

[w3schools](https://www.w3schools.com/sql/sql_injection.asp)

[Youtube - DVWA SQL Injection](https://www.youtube.com/watch?v=5bj1pFmyyBA)

[Youtube - DVWA Installation Tutorial](https://www.youtube.com/watch?v=WkyDxNJkgQ4)

[Youtube - Ethical Hacking 101](https://www.youtube.com/watch?v=2_lswM1S264)


