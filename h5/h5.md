# h5 Injected Sequel

Tehtävien tekemiseen käytettiin pöytäkonetta:

- Prosessori: AMD Ryzen 5 3600 6-Core Processor 3.59 GHz
- Kovalevy: 256 GB M.2 SSD, 512 GB SSD
- Muisti: 32GB RAM
- Käyttöjärjestelmä: Windows 10 Pro
- VirtualBox

Lisäksi virtuaalikonetta: Kali Linux (valmis paketti, oletusasetuksilla)

Tarkemmat tehtävänannot osoitteessa: *[terokarvinen.com](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h5-injected-sequel)*

## x) Lue/katso/kuuntele ja tiivistä.

Karvinen 2016: PostgreSQL Install and One Table Database – SQL CRUD tutorial for Ubuntu (kohdasta "Three line install" alkaen)

- asennus ```sudo apt-get install postgresql``` ja tietokannan käynnistys ```sudo systemctl start postgresql```
- tietokannan luominen omilla käyttäjätunnuksilla ```sudo -u postgres createdb käyttäjänimi```, käyttäjän luominen tietokantaan ```sudo -u postgres createuser käyttäjänimi```
- tietokannan avaaminen onnistuu komennolla ```psql```
- mikäli käyttämiseen tai komentoihin tarvitsee apua, käytä ```help```, poistumiseen ```q```
- ```CREATE TABLE``` taulun luomiseen, ```INSERT INTO``` arvojen lisäämiseen, ```SELECT``` haluttujen arvojen tarkasteluun, ```UPDATE``` arvojen päivittämiseen, ```DELETE``` tietueiden poistamiseen
- tauluille valittava aina pääavain (primary key), helpoin asettaa ```SERIAL```, jotta jokaiselle tietueelle annetaan uniikki avain automaattisesti järjestyksessä
  
*[Karvinen Tero - Postgresql Installation](https://terokarvinen.com/2016/03/05/postgresql-install-and-one-table-database-sql-crud-tutorial-for-ubuntu/)*

OWASP 2017: A1:2017-Injection

- melkein mikä tahansa data voi olla injektion "kuljettaja": ympäristömuuttujat, parametrit, ulkoiset ja sisäiset verkkopalvelut, kaikenlaiset käyttäjät
- haavoittuvuudet hyvinkin laajalle levinneitä: löytyy usein esim. SQL tai noSQL kyselyistä, OS komennoista, XML parsereista jne.
- vaikutukset: voi johtaa datan tuhoutumiseen, pilaantumiseen tai sen paljastumiseen valtuuksien ulkopuolisille osapuolille, vastuun menettämiseen tai pääsyn estämiseen
- sovellus on haavoittuvainen esim. kun:
-   - se ei validoi, filtteröi, tai siisti käyttäjän syöttämää dataa
    - dynaamiset haut tai parametrisoimattomien, asiayhteydettömien kutsujen "karkaamiset" tulkitsija käyttää suoraan
- muutama esimerkki miten voidaan ehkäistä:
    - turvallisen ohjelmointirajapinnan (API) käyttö, jolloin vältetään tulkin käyttö kokonaan, tai tarjotaan parametrisoitu rajapinta, tai muutetaan käyttäämään ORM-työkaluja
    - whitelist:n käyttö palvelinpuolen syötteen validoinnissa
- esimerkkihyökkäys: ```String q = "SELECT * FROM users WHERE userID='" + request.getParameter("id") + "'"```\
    &rarr; hyökkääjä muuttaa "id" parametrin arvoa selaimessa ```http://example.org/app/userView?id=' or '1'='1```\
    &rarr; muuttaa pyynnön merkitystä niin, että kaikki käyttäjä taulun tietueet palautetaan

*[OWASP - Injection](https://owasp.org/www-project-top-ten/2017/A1_2017-Injection)*

PortSwigger Academy: SQL injection (luvut lukuunottamatta "Blind SQL injection")

- SQL injektio on haavoittuvuus, joka sallii käyttäjän kajoamisen kyselyihin, joita sovellus tekee tietokantaansa
- onnistuneen hyökkäyksen seurauksena voidaan saada arkaluontoista dataa, kuten salasanoja, luottokorttitietoja tai henkilökohtaisia käyttäjätietoja
- haavoittuvuuksia voidaan tunnistaa järjestelmällisillä testeillä jokaiseen sovelluksen sisääntuloon, eli syötetään:
    - yksittäinen hipsu ```'``` ja etsitään virheitä/poikkeavuuksia
    - boolean ehdot kuten ```OR 1=1``` ja ```OR 1=2```, ja tarkastellaan eroja sovelluksen vastauksissa
    - payloadeja, jotka käynnistävät viiveitä suoritettaessa SQL-kyselyn sisällä, ja tarkastellaan eroja vastausten vasteessa
    - välimiesproxyn käyttö
- yleisiä injektio esimerkkejä: piilotetun datan hakeminen, sovelluksen logiikan kumoaminen, UNION-hyökkäykset, blind SQL injektio\
    &rarr; esim. käyttäjä erkki kirjautuu sisään salasanalla esimerkki:\
    ```SELECT * FROM users WHERE username = 'erkki' AND password = 'esimerkki'```\
    &rarr; kommentoimalla salasanan pois, voidaan kiertää kirjautumislogiikka:\
    ```SELECT * FROM users WHERE username = 'admin'--' AND password = ''```, ```--``` merkki viittaa kommenttiin SQL-kielessä\
    &rarr; kysely palauttaa admin nimisen käyttäjän, joten hyökkääjä pääsee kirjautumaan sisään kyseisellä käyttäjänimellä

*[Portswigger - SQL Injection](https://portswigger.net/web-security/sql-injection)*

Vapaaehtoinen: Karvinen 2019: MitmProxy on Kali and Xubuntu – attack and testing (Nykyisin asennus 'sudo apt-get install mitmproxy')

*[Karvinen Tero - Mitmproxy on Kali and xUbuntu](https://terokarvinen.com/2019/05/22/mitmproxy-on-kali-and-xubuntu-attack-and-testing/?fromSearch=mitmproxy)*

## a) Tee uusi PostgreSQL-tietokanta ja demonstroi create, read, update, delete (CRUD).

Aloitin tietokannan asennuksen *[ohjeiden](https://terokarvinen.com/2016/03/05/postgresql-install-and-one-table-database-sql-crud-tutorial-for-ubuntu/)* mukaisesti:

```console
┌──(kali㉿kali)-[~]
└─$ sudo apt-get -y install postgresql
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following packages were automatically installed and are no longer required:
  gcc-12-base libarmadillo11 libcanberra-gtk-module libcanberra-gtk0 libcbor0.8 libcodec2-1.1 libcurl3-nss
  libgcc-12-dev libgumbo1 libgupnp-igd-1.0-4 libjim0.81 libnfs13 libobjc-12-dev libstdc++-12-dev
  libtexluajit2 libutf8proc2 libvpx7 lua-lpeg nss-plugin-pem python3-jdcal python3-pyminifier
Use 'sudo apt autoremove' to remove them.
The following additional packages will be installed:
  postgresql-client-common postgresql-common
# ....
# rivejä poistettu 
```
Tämän jälkeen käynnistin tietokannan.

```console
┌──(kali㉿kali)-[~]
└─$ sudo systemctl start postgresql
# vielä tarkistus, että päällä:
┌──(kali㉿kali)-[~]
└─$ sudo systemctl status postgresql
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; preset: disabled)
     Active: active (exited) since Tue 2023-11-21 20:11:01 EET; 48s ago
    Process: 7161 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 7161 (code=exited, status=0/SUCCESS)
        CPU: 1ms

Nov 21 20:11:01 kali systemd[1]: Starting postgresql.service - PostgreSQL RDBMS...
Nov 21 20:11:01 kali systemd[1]: Finished postgresql.service - PostgreSQL RDBMS.
```
Ryhtyessäni luomaan tietokantaa, sain virheilmoituksen:

```console
┌──(kali㉿kali)-[~]
└─$ sudo -u postgres createdb $(whoami)  
could not change directory to "/home/kali": Permission denied
```

Pienen pohdinnan jälkeen siirryin home-kansiosta juureen ja droppasin tietokannan. Se olisi saattanut toimia täysin normaalisti kyseisistä ilmoituksista huolimatta, mutta loin kuitenkin uuden:

```console
┌──(kali㉿kali)-[/]
└─$ sudo -u postgres drodb kali
┌──(kali㉿kali)-[/]
└─$ sudo -u postgres createdb $(whoami)
┌──(kali㉿kali)-[/]
└─$ sudo -u postgres createuser $(whoami)
```
Tällä kertaa ei tullut mitään huomautuksia, joten oletettavasti kaikki toimi toivotusti. Seuraava ongelma kuitenkin tuli vastaan, kun yritin luoda uutta taulua kyseiseen tietokantaan: 

```console
┌──(kali㉿kali)-[/]
└─$ psql         
psql (16.0 (Debian 16.0-2), server 15.4 (Debian 15.4-3))
Type "help" for help.

kali=> CREATE TABLE customers (id SERIAL PRIMARY KEY, name VARCHAR(200), address varchar(200));
ERROR:  permission denied for schema public
```

Löysin *[artikkelin](https://www.cybertec-postgresql.com/en/error-permission-denied-schema-public/)*, josta kävi ilmi, että PostgreSQL versioista 15 ylöspäin ainoastaan tietokannan omistajalla on oikeudet luoda public schemaan. Pohdin siis, voisiko tämä olla syynä. Ilmeisesti jo luomalleni käyttäjälle olisi pitänyt antaa laajemmat oikeudet. Löysin Youtubesta *[videon](https://www.youtube.com/watch?v=tducLYZzElo&t=272s)*, josta kävi ilmi, että PostgreSQL asentaa oletuksena käyttäjän "postgres". Ei mikään paras ohjevideo, mutta päätin kokeilla, jos onnistuisin tällä ohjeella. Kirjautuminen onnistui, sillä rivillä näkyi nyt käyttäjä ```postgres@kali```. Skippasin toistaiseksi oman käyttäjän luomisen, ja kokeilin luoda tietokannan suoraan postgres-käyttäjällä. Se näytti onnistuvan, kuten myös tietokantaan siirtyminen. Tarkistin yhteyden vielä komennolla ```\conninfo```. 

```console
┌──(kali㉿kali)-[/]
└─$ sudo -i -u postgres          
┏━(Message from Kali developers)
┃
┃ This is a minimal installation of Kali Linux, you likely
┃ want to install supplementary tools. Learn how:
┃ ⇒ https://www.kali.org/docs/troubleshooting/common-minimum-setup/
┃
┗━(Run: “touch ~/.hushlogin” to hide this message)
postgres@kali:~$ createdb testi
postgres@kali:~$ psql -d testi 
psql (16.0 (Debian 16.0-2), server 15.4 (Debian 15.4-3))
Type "help" for help.

testi=# \conninfo
You are connected to database "testi" as user "postgres" via socket in "/var/run/postgresql" at port "5432".
```
Tämän jälkeen loin ensimmäisen taulun, joka näytti tällä kertaa onnistuvan ilman virheitä.

```console
testi=# CREATE TABLE customers (id SERIAL PRIMARY KEY, name VARCHAR(200), phone VARCHAR(100));
CREATE TABLE
testi=# \d customers
                                    Table "public.customers"
 Column |          Type          | Collation | Nullable |                Default                
--------+------------------------+-----------+----------+---------------------------------------
 id     | integer                |           | not null | nextval('customers_id_seq'::regclass)
 name   | character varying(200) |           |          | 
 phone  | character varying(100) |           |          | 
Indexes:
    "customers_pkey" PRIMARY KEY, btree (id)
```

### INSERT

Taulun luomisen jälkeen syötin siihen ensimmäisen tietueen, eli nimeen arvon Matti, ja puhelinnumeroksi 040-1234567. Tämän jälkeen lisäsin tauluun vielä 2 riviä lisää.

```console
testi=# INSERT INTO customers (name, phone) VALUES ('Matti', '040-1234567');
INSERT 0 1
testi=# SELECT * FROM customers;
 id | name  |    phone    
----+-------+-------------
  1 | Matti | 040-1234567
(1 row)
```

### SELECT

Tarkasteltaessa kaikkia taulussa olevia tietueita, käytin SELECT-komentoa:

```console
testi=# SELECT * FROM customers;
 id | name  |    phone    
----+-------+-------------
  1 | Matti | 040-1234567
  2 | Mikko | 040-2345678
  3 | Maisa | 040-2345679
(3 rows)
```

### UPDATE

Kokeilin päivittää asiakkaan Matti puhelinnumeron, ja tarkistin päivitetyn taulun tiedot:

```console
testi=# UPDATE customers SET phone='050-1234567' WHERE phone='040-1234567';
UPDATE 1
testi=# SELECT * FROM customers;
 id | name  |    phone    
----+-------+-------------
  2 | Mikko | 040-2345678
  3 | Maisa | 040-2345679
  1 | Matti | 050-1234567
(3 rows)
```

### DELETE

Viimeisenä testinä vielä asiakkaan nimeltä Mikko poistaminen:

```console
testi=# DELETE FROM customers WHERE name='Mikko';
DELETE 1
testi=# SELECT * FROM customers;
 id | name  |    phone    
----+-------+-------------
  3 | Maisa | 040-2345679
  1 | Matti | 050-1234567
(2 rows)
```

## b) Kuvaile yksinkertainen SQL-injektio, ja demonstroi se omaan tietokantaasi psql-komennolla. Selitä, mikä osa on käyttäjän syötettä ja mikä valmiina ohjelmassa.



# Lähteet

[Cybertec - Error permission denied](https://www.cybertec-postgresql.com/en/error-permission-denied-schema-public/)

[OWASP - Injection](https://owasp.org/www-project-top-ten/2017/A1_2017-Injection)

[Portswigger - SQL Injection](https://portswigger.net/web-security/sql-injection)

[Karvinen Tero - h5: Injected Sequel](https://terokarvinen.com/2023/eettinen-hakkerointi-2023/#h5-injected-sequel)

[Karvinen Tero - Mitmproxy on Kali and xUbuntu](https://terokarvinen.com/2019/05/22/mitmproxy-on-kali-and-xubuntu-attack-and-testing/?fromSearch=mitmproxy)

[Karvinen Tero - Postgresql Installation](https://terokarvinen.com/2016/03/05/postgresql-install-and-one-table-database-sql-crud-tutorial-for-ubuntu/)

[Youtube](https://www.youtube.com/watch?v=tducLYZzElo&t=272s)

